<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ilex.frb &mdash; ILEX 0.9.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=39bb1c6d"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ILEX
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Overview of ILEX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials.html">ILEX Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/ilex.html">ILEX Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ILEX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ilex.frb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ilex.frb</h1><div class="highlight"><pre>
<span></span><span class="c1">##===============================================##</span>
<span class="c1">##===============================================##</span>
<span class="c1">## Author: Tyson Dial</span>
<span class="c1">## Email: tdial@swin.edu.au</span>
<span class="c1">## Last Updated: 25/09/2023 </span>
<span class="c1">##</span>
<span class="c1">##</span>
<span class="c1">## </span>
<span class="c1">## </span>
<span class="c1">## Library of basic functions for analysing FRBs.</span>
<span class="c1">##</span>
<span class="c1">##===============================================##</span>
<span class="c1">##===============================================##</span>
<span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">.pyfit</span> <span class="kn">import</span> <span class="n">fit</span><span class="p">,</span> <span class="n">_posterior</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1">## import utils ##</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">load_data</span><span class="p">,</span> <span class="n">save_data</span><span class="p">,</span> <span class="n">dict_get</span><span class="p">,</span>
                    <span class="n">dict_init</span><span class="p">,</span> <span class="n">dict_isall</span><span class="p">,</span>
                    <span class="n">merge_dicts</span><span class="p">,</span> <span class="n">dict_null</span><span class="p">,</span> <span class="n">get_stk_from_datalist</span><span class="p">,</span> <span class="n">load_param_file</span><span class="p">,</span>
                    <span class="n">set_plotstyle</span><span class="p">,</span> <span class="n">fix_ds_freq_lims</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">## import FRB stats ##</span>
<span class="kn">from</span> <span class="nn">.fitting</span> <span class="kn">import</span> <span class="p">(</span><span class="n">fit_RMquad</span><span class="p">,</span> <span class="n">fit_RMsynth</span><span class="p">,</span> <span class="n">lorentz</span><span class="p">,</span>
                     <span class="n">make_scatt_pulse_profile_func</span><span class="p">)</span>

<span class="c1">## import FRB params ##</span>
<span class="kn">from</span> <span class="nn">.par</span> <span class="kn">import</span> <span class="n">FRB_params</span><span class="p">,</span> <span class="n">FRB_metaparams</span>

<span class="c1"># ## import FRB htr functions ##</span>
<span class="c1"># from .htr import make_stokes</span>

<span class="c1">## import globals ##</span>
<span class="kn">from</span> <span class="nn">.globals</span> <span class="kn">import</span> <span class="n">_G</span><span class="p">,</span> <span class="n">c</span>

<span class="c1">## import plot functions ##</span>
<span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="p">(</span><span class="n">plot_RM</span><span class="p">,</span> <span class="n">plot_PA</span><span class="p">,</span> <span class="n">plot_stokes</span><span class="p">,</span>      
                  <span class="n">plot_poincare_track</span><span class="p">,</span> <span class="n">create_poincare_sphere</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">)</span>

<span class="c1">## import processing functions ##</span>
<span class="c1"># from .FRBproc import proc_data</span>

<span class="kn">from</span> <span class="nn">.logging</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">get_verbose</span><span class="p">,</span> <span class="n">set_verbose</span><span class="p">,</span> <span class="n">log_title</span>


<span class="kn">from</span> <span class="nn">.master_proc</span> <span class="kn">import</span> <span class="n">master_proc_data</span>



    

<span class="c1">##===============================================##</span>
<span class="c1">##                  FRB class                    ##</span>
<span class="c1">##===============================================##</span>

<div class="viewcode-block" id="FRB">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB">[docs]</a>
<span class="k">class</span> <span class="nc">FRB</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FRB class for Processing of ASKAP FRB data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str </span>
<span class="sd">        Name of FRB</span>
<span class="sd">    RA: str </span>
<span class="sd">        Right acension position</span>
<span class="sd">    DEC: str </span>
<span class="sd">        Declination position</span>
<span class="sd">    MJD: float</span>
<span class="sd">        Modified Julian date in days</span>
<span class="sd">    DM: float </span>
<span class="sd">        Dispersion Measure</span>
<span class="sd">    bw: float </span>
<span class="sd">        Bandwidth</span>
<span class="sd">    cfreq: float </span>
<span class="sd">        Central Frequency</span>
<span class="sd">    t_crop: list </span>
<span class="sd">        Crop start and end phase in Time</span>
<span class="sd">    f_crop: list </span>
<span class="sd">        Crop start and end phase in Frequency</span>
<span class="sd">    tN: int </span>
<span class="sd">        Factor for averaging in Time</span>
<span class="sd">    fN: int </span>
<span class="sd">        Factor for averaging in Frequency</span>
<span class="sd">    t_lim: list </span>
<span class="sd">        Limits for FRB in Time</span>
<span class="sd">    f_lim: list </span>
<span class="sd">        Limits for FRB in Frequency</span>
<span class="sd">    t_lim_base: list</span>
<span class="sd">        Base limits of FRB in time (not including t_ref)</span>
<span class="sd">    f_lim_base: list</span>
<span class="sd">        Base limits of FRB in freq </span>
<span class="sd">    t_ref: float</span>
<span class="sd">        Reference zero-point in time</span>
<span class="sd">    RM: float </span>
<span class="sd">        Rotation Measure</span>
<span class="sd">    f0: float </span>
<span class="sd">        Reference Frequency</span>
<span class="sd">    pa0: float </span>
<span class="sd">        Position angle at reference frequency f0</span>
<span class="sd">    zapchan: str</span>
<span class="sd">        string used for zapping channels, in format -&gt; &quot;850, 860, 870:900&quot; \n</span>
<span class="sd">        each element seperated by a &#39;,&#39; is a seperate channel. If &#39;:&#39; is used, user can specify a range of values \n</span>
<span class="sd">        i.e. 870:900 -&gt; from channel 870 to 900 inclusive of both.</span>
<span class="sd">    verbose: bool </span>
<span class="sd">        Enable verbose logging</span>
<span class="sd">    norm: str</span>
<span class="sd">        Type of normalisation \n</span>
<span class="sd">        [max] - normalise using maximum \n</span>
<span class="sd">        [absmax] - normalise using absolute maximum \n</span>
<span class="sd">        [None] - Skip normalisation</span>
<span class="sd">    terr_crop: list</span>
<span class="sd">        bounds for off-pulse region in time [min, max] [ms], default is None</span>
<span class="sd">    yaml_file: str</span>
<span class="sd">        parameter yaml file of FRB to load in, default is None</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    par: FRB_params </span>
<span class="sd">        parameters for FRB</span>
<span class="sd">    this_par: FRB_params </span>
<span class="sd">        Current instance of &#39;par&#39;</span>
<span class="sd">    prev_par: FRB_params </span>
<span class="sd">        Last instance of &#39;par&#39;</span>
<span class="sd">    metapar: FRB_metaparams </span>
<span class="sd">        hold meta-parameters for FRB</span>
<span class="sd">    this_metapar: FRB_metaparams </span>
<span class="sd">        Current instance of &#39;metapar&#39;</span>
<span class="sd">    prev_metapar: FRB_metaparams </span>
<span class="sd">        Last instance of &#39;metapar&#39;</span>
<span class="sd">    ds: Dict </span>
<span class="sd">        Dictionary of loaded stokes dynamic spectra</span>
<span class="sd">    pol: Dict </span>
<span class="sd">        Dictionary of loaded Polarisation time series</span>
<span class="sd">    _t: Dict </span>
<span class="sd">        Dictionary of cropped stokes time series</span>
<span class="sd">    _f: Dict </span>
<span class="sd">        Dictionary of cropped stokes spectra</span>
<span class="sd">    _ds: Dict </span>
<span class="sd">        Dictionary of cropped stokes dynamic spectra</span>
<span class="sd">    _freq: np.ndarray </span>
<span class="sd">        Cropped Frequency array [MHz]</span>
<span class="sd">    _time: np.ndarray</span>
<span class="sd">        Cropped time array [ms]</span>
<span class="sd">    verbose: bool </span>
<span class="sd">        Enable logging</span>
<span class="sd">    savefig: bool </span>
<span class="sd">        Save all created figures to files</span>
<span class="sd">    pcol: str </span>
<span class="sd">        Color of text for logging</span>
<span class="sd">    empty: bool </span>
<span class="sd">        Variable used to initialise FRB instance and data loading</span>
<span class="sd">    plot_type: str</span>
<span class="sd">        type of plot \n</span>
<span class="sd">        [scatter] - scatter plot with error bars \n</span>
<span class="sd">        [lines] - line plot with error patches</span>
<span class="sd">    show_plots: bool</span>
<span class="sd">        If true, shows plots</span>
<span class="sd">    save_plots: bool</span>
<span class="sd">        If true, saves plots to file</span>
<span class="sd">    residuals: bool</span>
<span class="sd">        if true, a residual panel will appear when plotting a fit using pyfit, default is True</span>
<span class="sd">    plotPosterior: bool</span>
<span class="sd">        if true, will save posterior corner plot when fitting using bayesian method, default is True</span>
<span class="sd">    apply_tw: bool</span>
<span class="sd">        if true, apply time dependant weights when scrunching in time, i.e making spectra, default is True</span>
<span class="sd">    apply_fw: bool</span>
<span class="sd">        if true, apply freq dependant weights when scrunching in freq, i.e. making time profiles, default is True</span>
<span class="sd">    fitted_params: dict</span>
<span class="sd">        dictionary of fitted values, i.e. RM</span>
<span class="sd">    &quot;&quot;&quot;</span>




    <span class="c1">## [ INITIALISE FRB ] ##</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>    <span class="n">RA</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">],</span>    <span class="n">DEC</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span> 
                       <span class="n">MJD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;MJD&#39;</span><span class="p">],</span> <span class="n">DM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;DM&#39;</span><span class="p">],</span>      <span class="n">bw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;bw&#39;</span><span class="p">],</span>    <span class="n">cfreq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cfreq&#39;</span><span class="p">],</span> 
                       <span class="n">t_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>               <span class="n">f_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>           <span class="n">tN</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">fN</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>                 <span class="n">t_lim_base</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;t_lim_base&#39;</span><span class="p">],</span>   <span class="n">f_lim_base</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f_lim_base&#39;</span><span class="p">],</span>
                       <span class="n">RM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">],</span>      <span class="n">f0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>  <span class="n">pa0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pa0&#39;</span><span class="p">],</span>
                       <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">],</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> 
                       <span class="n">df</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">],</span>      <span class="n">zapchan</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;zapchan&#39;</span><span class="p">],</span> <span class="n">terr_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t_ref</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;t_ref&#39;</span><span class="p">],</span>       
                       <span class="n">yaml_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create FRB instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">FRB_params</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">RA</span> <span class="o">=</span> <span class="n">RA</span><span class="p">,</span> <span class="n">DEC</span> <span class="o">=</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">MJD</span> <span class="o">=</span> <span class="n">MJD</span><span class="p">,</span> 
                              <span class="n">DM</span> <span class="o">=</span> <span class="n">DM</span><span class="p">,</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">bw</span><span class="p">,</span> <span class="n">cfreq</span> <span class="o">=</span> <span class="n">cfreq</span><span class="p">,</span>
                              <span class="n">t_lim_base</span> <span class="o">=</span> <span class="n">t_lim_base</span><span class="p">,</span> <span class="n">f_lim_base</span> <span class="o">=</span> <span class="n">f_lim_base</span><span class="p">,</span> 
                              <span class="n">RM</span> <span class="o">=</span> <span class="n">RM</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">f0</span><span class="p">,</span> <span class="n">pa0</span> <span class="o">=</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span> <span class="n">t_ref</span> <span class="o">=</span> <span class="n">t_ref</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span> <span class="o">=</span> <span class="n">FRB_params</span><span class="p">(</span><span class="n">EMPTY</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span> <span class="o">=</span> <span class="n">FRB_metaparams</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">t_crop</span><span class="p">,</span> <span class="n">f_crop</span> <span class="o">=</span> <span class="n">f_crop</span><span class="p">,</span>
                        <span class="n">terr_crop</span> <span class="o">=</span> <span class="n">terr_crop</span><span class="p">,</span> <span class="n">tN</span> <span class="o">=</span> <span class="n">tN</span><span class="p">,</span> <span class="n">fN</span> <span class="o">=</span> <span class="n">fN</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">t_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">t_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>    <span class="c1"># crop of time axis</span>
        <span class="k">if</span> <span class="n">f_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">f_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>    <span class="c1"># crop of frequency axis</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span> <span class="o">=</span> <span class="n">FRB_metaparams</span><span class="p">(</span><span class="n">EMPTY</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


        <span class="c1">## Create data containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container for Dynamic spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol</span> <span class="o">=</span> <span class="p">{}</span>                   <span class="c1"># container for polarisation time series data (X, Y)</span>

        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="s2">&quot;XY&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        
        <span class="c1">## data instance containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container to store time series data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container to store frequency spectra data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="p">{}</span>                   <span class="c1"># container to store dynamic spectra data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># container to store baseband frequency data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># container to store time samples </span>

        <span class="c1"># initilise data containers</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="s2">&quot;XY&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>               <span class="c1"># used to initialise FRB instance and data loading </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>          <span class="c1"># TODO: implement</span>
        <span class="c1"># set verbose</span>
        <span class="n">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span> <span class="o">=</span> <span class="s1">&#39;cyan&#39;</span>              <span class="c1"># color for verbose printing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_type</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span>    <span class="c1"># type of errorbar plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># plot residuals when plotting fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotPosterior</span> <span class="o">=</span> <span class="kc">True</span>      <span class="c1"># plot posterior corner plot when plotting fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="o">=</span> <span class="s2">&quot;physical&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zap</span> <span class="o">=</span> <span class="kc">False</span>                <span class="c1"># if True, will treat arrays as zapped</span>

        <span class="c1"># weightings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_tW</span> <span class="o">=</span> <span class="kc">True</span>                  <span class="c1"># apply time weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_fW</span> <span class="o">=</span> <span class="kc">True</span>                  <span class="c1"># apply freq weights</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_isinstance</span> <span class="o">=</span> <span class="kc">False</span>        <span class="c1"># if data instance is valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1"># quick load yaml file</span>
        <span class="k">if</span> <span class="n">yaml_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">yaml_file</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="p">)</span>



    <span class="c1">##===============================================##</span>
    <span class="c1">##            retrive data funtions              ##</span>
    <span class="c1">##===============================================##</span>

    
    <span class="c1">## [ LOAD IN DATA ] ##</span>
<div class="viewcode-block" id="FRB.load_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.load_data">[docs]</a>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsI</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dsQ</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dsU</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dsV</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">yaml_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mmap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load Stokes HTR data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dsI: str </span>
<span class="sd">            Filename of stokes I dynamic spectra</span>
<span class="sd">        dsQ: str </span>
<span class="sd">            Filename of stokes Q dynamic spectra</span>
<span class="sd">        dsU: str </span>
<span class="sd">            Filename of stokes U dynamic spectra</span>
<span class="sd">        dsV: str </span>
<span class="sd">            Filename of stokes V dynamic spectra</span>
<span class="sd">        yaml_file: str </span>
<span class="sd">            parameter yaml file for FRB, default is None</span>
<span class="sd">        mmap: bool </span>
<span class="sd">            Enable memory mapping for loading</span>
<span class="sd">        _init: bool </span>
<span class="sd">            For initial Data loading</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_title</span><span class="p">(</span><span class="s2">&quot;Loading in Stokes dynamic spectra. Assuming the data being loaded are .npy files&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">yaml_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading from yaml file&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

            <span class="c1"># load pars</span>
            <span class="n">yaml_pars</span> <span class="o">=</span> <span class="n">load_param_file</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">)</span>

            <span class="c1"># extract pars</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">],</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;metapar&#39;</span><span class="p">],</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;hyperpar&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">pars</span><span class="p">)</span>

            <span class="c1"># set weights if given</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">xtype</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">xtype</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">])</span>

            <span class="c1"># set loaded files</span>
            <span class="n">dsI</span><span class="p">,</span> <span class="n">dsQ</span> <span class="o">=</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;dsI&#39;</span><span class="p">],</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;dsQ&#39;</span><span class="p">]</span>
            <span class="n">dsU</span><span class="p">,</span> <span class="n">dsV</span> <span class="o">=</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;dsU&#39;</span><span class="p">],</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;dsV&#39;</span><span class="p">]</span>

            <span class="c1"># check if plotstyle file is given</span>
            <span class="n">set_plotstyle</span><span class="p">(</span><span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">][</span><span class="s1">&#39;plotstyle_file&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">][</span><span class="s1">&#39;plotstyle_file&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Setting plotting style: Default&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setting plotting style: </span><span class="si">{</span><span class="n">yaml_pars</span><span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">][</span><span class="s1">&#39;plotstyle_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">init_par_from_load</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialise a number of parameters from loaded file</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                     <span class="c1"># assumed that dyn spec is [freq,time]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim_base</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nsamp</span><span class="p">]</span>

            <span class="c1"># check if any channels are nan&#39;s i.e. flagged</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zap</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1">## dict. of files that will be loaded in</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dsI&quot;</span><span class="p">:</span> <span class="n">dsI</span><span class="p">,</span> <span class="s2">&quot;dsQ&quot;</span><span class="p">:</span> <span class="n">dsQ</span><span class="p">,</span> <span class="s2">&quot;dsU&quot;</span><span class="p">:</span> <span class="n">dsU</span><span class="p">,</span> <span class="s2">&quot;dsV&quot;</span><span class="p">:</span> <span class="n">dsV</span><span class="p">}</span>

        <span class="c1"># loop through files</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">init_key</span> <span class="o">=</span> <span class="n">key</span>

                <span class="c1"># load all dynamic spectra</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mmap</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading stokes </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> Dynspec from: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> with shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">lpf_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="n">init_par_from_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">init_key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span></div>






        

        
    <span class="c1">## [ SAVING FUNCTION - SAVE CROP OF DATA ] ##</span>
<div class="viewcode-block" id="FRB.save_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.save_data">[docs]</a>
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">yaml_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save current instance data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list : List(str), optional</span>
<span class="sd">            List of data to save, by default None</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            Common Pre-fix for saved data, by default None, if None the name parameter of the</span>
<span class="sd">            FRB class will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_title</span><span class="p">(</span><span class="s2">&quot;Saving Stokes data, the data is saved as .npy files. &quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yaml_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># save parmaters to yaml file</span>
            <span class="k">pass</span>



        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;No data specified for saving...&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span>


        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Saving the following data products:&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> 
        

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frbname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">frbname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frbname</span> <span class="o">=</span> <span class="s2">&quot;FRBXXXXXX&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">frbname</span><span class="p">)</span>

        <span class="c1"># save data</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pdat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span> <span class="n">pdat</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>

        <span class="k">return</span></div>





<div class="viewcode-block" id="FRB.set">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.set">[docs]</a>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set FRB parameters, see class parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># update pars</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_par</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="o">**</span><span class="n">par</span><span class="p">)</span>

        <span class="c1"># update metapars</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">set_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">metapar</span><span class="p">)</span>

        <span class="c1"># update hyperpars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hyperpar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>        </div>







<div class="viewcode-block" id="FRB.get_freqs">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.get_freqs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Frequencies</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span></div>





        
    <span class="c1"># implement FRB_params struct  </span>
    <span class="c1">## [ GET DATA ] ##</span>
<div class="viewcode-block" id="FRB.get_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.get_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ignore_nans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make new instance of loaded data. This will take a crop of the </span>
<span class="sd">        loaded mmap-ed stokes data, pass it through the back-end processing</span>
<span class="sd">        function and save the data in memory in the ._ds, _t, _f, _time and _freq</span>
<span class="sd">        class instance attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list : List(str) or str, optional</span>
<span class="sd">            List of data products to load in, by default &quot;dsI&quot;</span>
<span class="sd">        get : bool, optional</span>
<span class="sd">            Return new crops of data, by default False and will only save data</span>
<span class="sd">            instances to class container attributes</span>
<span class="sd">        ignore_nans : bool, optional</span>
<span class="sd">            If true, if nans exist in data, they will be removed before saving the data instance</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data: Dict, optional</span>
<span class="sd">            Dictionary of processed data crops, by default None if get = False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_title</span><span class="p">(</span><span class="s2">&quot;Retrieving Processed Data products. Any currently loaded crops of data will be overwritten. &quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1"># update par and metapar if nessesary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        
        <span class="c1"># process data_list as str</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_list</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hkeys</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_list</span><span class="p">]</span>
                
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving the following data: </span><span class="si">{</span><span class="n">data_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># get all data products needed</span>
        <span class="n">data_products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_proc</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>


        <span class="c1">## first check if there is data to use</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isvalid</span><span class="p">(</span><span class="n">data_products</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loaded data not avaliable or incorrect DS shapes&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span>
                <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isinstance</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> 

        <span class="c1">## make new instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_instance</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">ignore_nans</span><span class="p">)</span>


        <span class="c1">## set new instance param </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">_isinstance</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># check if get is true</span>
        <span class="k">if</span> <span class="n">get</span><span class="p">:</span>
            <span class="c1"># return instance</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">ignore_nans</span><span class="p">)</span>


        <span class="c1">#return data</span>
        <span class="k">return</span></div>




    <span class="c1"># def _check_instance(self, data_list = None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Run through unit checks of current instance of crops, do all crops match in shape,</span>
    <span class="c1">#     have any parameters changed since last call to get_data().</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     data_list : List(str), optional</span>
    <span class="c1">#         data to check, by default None</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     bool</span>
    <span class="c1">#         0 if failed, 1 if passed</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     if self.force_reload:</span>
    <span class="c1">#         log(&quot;forcing reload of data&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>

    <span class="c1">#     if not dict_isall(self.prev_par.par2dict(), </span>
    <span class="c1">#                       self.this_par.par2dict()):</span>
    <span class="c1">#         log(&quot;params do not match&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>
        
    <span class="c1">#     if not dict_isall(self.prev_metapar.metapar2dict(),</span>
    <span class="c1">#                       self.this_metapar.metapar2dict()):</span>
    <span class="c1">#         log(&quot;metaparams do not match&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>

    <span class="c1">#     # flags</span>
    <span class="c1">#     err_flag = self._iserr()</span>

        
    <span class="c1">#     ## check for data in instance</span>
    <span class="c1">#     _shape = {&quot;ds&quot;:[], &quot;t&quot;:[], &quot;f&quot;:[]}</span>
    <span class="c1">#     freq_shape = 0</span>
    <span class="c1">#     time_shape = 0</span>
    <span class="c1">#     for data in data_list:</span>
    <span class="c1">#         stk = data[-1]</span>
            
    <span class="c1">#         # dynamic spectra</span>
    <span class="c1">#         if data[:2] == &quot;ds&quot;:</span>
    <span class="c1">#             dat = self._ds[stk]</span>
    <span class="c1">#             typ = &quot;ds&quot;</span>
            
    <span class="c1">#         # time series</span>
    <span class="c1">#         if data[0] == &quot;t&quot;:</span>
    <span class="c1">#             dat = self._t[stk]</span>
    <span class="c1">#             daterr = self._t[f&quot;{stk}err&quot;]</span>
    <span class="c1">#             typ = &quot;t&quot;</span>

    <span class="c1">#         # frequency spectra</span>
    <span class="c1">#         if data[0] == &quot;f&quot;:</span>
    <span class="c1">#             dat = self._f[stk]</span>
    <span class="c1">#             daterr = self._f[f&quot;{stk}err&quot;]</span>
    <span class="c1">#             typ = &quot;f&quot;</span>

            
    <span class="c1">#         # check data</span>
    <span class="c1">#         if dat is None:</span>
    <span class="c1">#             log(f&quot;{data} is missing, will be made&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>
    <span class="c1">#         _shape[typ].append(dat.shape)</span>
    <span class="c1">#         if err_flag and typ != &quot;ds&quot;:</span>
    <span class="c1">#             if daterr is None:</span>
    <span class="c1">#                 log(f&quot;{data}err is missing, will be made&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#                 return 0</span>
    <span class="c1">#             if typ == &quot;f&quot;:</span>
    <span class="c1">#                 _shape[typ].append(daterr.shape)</span>


    <span class="c1">#         # frequency band array</span>
    <span class="c1">#         elif data == &quot;freq&quot;:</span>
    <span class="c1">#             if self._freq is None:</span>
    <span class="c1">#                 log(&quot;freq data is missing, will be made&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#                 return 0</span>
    <span class="c1">#             freq_shape = self._freq.shape</span>
            
    <span class="c1">#         elif data == &quot;time&quot;:</span>
    <span class="c1">#             if self._time is None:</span>
    <span class="c1">#                 log(&quot;time data is missing, will be made&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#                 return 0</span>
    <span class="c1">#             time_shape = self._time.shape</span>


    <span class="c1">#     ## check if all shapes match up</span>
    <span class="c1">#     if not all(x==_shape[&#39;ds&#39;][0] for x in _shape[&#39;ds&#39;]):</span>
    <span class="c1">#         log(&quot;cropped ds shapes do not match, will be remade&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>
        
    <span class="c1">#     if not all(x==_shape[&#39;t&#39;][0] for x in _shape[&#39;t&#39;]):</span>
    <span class="c1">#         log(&quot;cropped t shapes do not match, will be remade&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>

    <span class="c1">#     if not all(x==_shape[&#39;f&#39;][0] for x in _shape[&#39;f&#39;]):</span>
    <span class="c1">#         log(&quot;cropped f shapes do not match, will be remade&quot;, stype = &quot;warn&quot;)</span>
    <span class="c1">#         return 0</span>

    <span class="c1">#     ## check if cross products i.e. ds and t match up</span>
    <span class="c1">#     if len(_shape[&#39;ds&#39;]) &gt; 0 and len(_shape[&#39;t&#39;]) &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;ds&#39;][0][1] != _shape[&#39;t&#39;][0][0]:</span>
    <span class="c1">#             log(f&quot;# samples for ds and t do not match, data will be remade\n{_shape[&#39;ds&#39;][0][1]} != {_shape[&#39;t&#39;][0][0]}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>
        
    <span class="c1">#     if len(_shape[&#39;ds&#39;]) &gt; 0 and len(_shape[&#39;f&#39;]) &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;ds&#39;][0][0] != _shape[&#39;f&#39;][0][0]:</span>
    <span class="c1">#             log(f&quot;# channels for ds and f do not match, data will be remade\n{_shape[&#39;ds&#39;][0][0]} != {_shape[&#39;t&#39;][0][0]}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>
        
    <span class="c1">#     if len(_shape[&#39;ds&#39;]) &gt; 0 and freq_shape &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;ds&#39;][0][0] != freq_shape:</span>
    <span class="c1">#             log(f&quot;# channels for ds and freq do not match, data will be remade\n{_shape[&#39;ds&#39;][0][0]} != {freq_shape}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>

    <span class="c1">#     if len(_shape[&#39;ds&#39;]) &gt; 0 and time_shape &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;ds&#39;][0][1] != time_shape:</span>
    <span class="c1">#             log(f&quot;# samples for ds and time do not match, data will be remade\n{_shape[&#39;ds&#39;][0][1]} != {time_shape}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>
            
    <span class="c1">#     if len(_shape[&#39;f&#39;]) &gt; 0 and freq_shape &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;f&#39;][0][0] != freq_shape:</span>
    <span class="c1">#             log(f&quot;# channels for f and freq do not match, data will be remade\n{_shape[&#39;f&#39;][0][0]} != {freq_shape}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;)</span>
    <span class="c1">#             return 0</span>
        
    <span class="c1">#     if len(_shape[&#39;t&#39;]) &gt; 0 and time_shape &gt; 0:</span>
    <span class="c1">#         if _shape[&#39;t&#39;][0][0] != time_shape:</span>
    <span class="c1">#             log(f&quot;# samples for t and time do not match, data will be remade\n{_shape[&#39;t&#39;][0][0]} != {time_shape}&quot;,</span>
    <span class="c1">#                 stype = &quot;warn&quot;) </span>
    <span class="c1">#             return 0               </span>

        
    <span class="c1">#     ## all checks passed, return true</span>
    <span class="c1">#     return 1</span>



    <span class="k">def</span> <span class="nf">_get_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore_nans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        retrieve data products</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list : List(str), optional</span>
<span class="sd">            crop types to return, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data: Dict</span>
<span class="sd">            Dictionary of data crops</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialise new data list</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># ingore nans? -&gt; make mask for this process</span>
        <span class="n">f_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore_nans</span><span class="p">:</span>
            <span class="c1"># find first data that isn&#39;t None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="c1"># if no freq data, just pass through </span>
                <span class="k">break</span>



        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># dynamic spectra</span>
            <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">][</span><span class="n">f_mask</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># time series</span>
            <span class="k">elif</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

            <span class="c1"># frequency spectra</span>
            <span class="k">elif</span> <span class="s2">&quot;f&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">][</span><span class="n">f_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

        <span class="c1"># also add freqs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_data</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="n">f_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get freq array, something went wrong&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>

        <span class="c1"># also add times</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get time array, something went wrong&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
        

        <span class="k">return</span> <span class="n">new_data</span>



    <span class="k">def</span> <span class="nf">_make_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore_nans</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make New data crops for current instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list : List(str), optional</span>
<span class="sd">            List of crop products to make, by default None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># assuming all prior checks on data were successful</span>

        <span class="c1"># purge everything</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span><span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># get frequencies</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>
        

        <span class="c1"># set up parameter dictionary</span>
        <span class="n">full_par</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">(),</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">())</span>

        <span class="c1"># get tW and fW</span>
        <span class="n">temp_w_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">temp_w_par</span><span class="o">.</span><span class="n">update_from_crop</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">full_par</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">],</span>
                                        <span class="n">f_crop</span> <span class="o">=</span> <span class="n">full_par</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_tW</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Retrieving Time Weights&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;=======================&quot;</span><span class="p">)</span>
            <span class="n">full_par</span><span class="p">[</span><span class="s1">&#39;tW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">tW</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">temp_w_par</span><span class="o">.</span><span class="n">get_times</span><span class="p">())</span>
            <span class="n">log</span><span class="p">(</span><span class="n">temp_w_par</span><span class="o">.</span><span class="n">tW</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_fW</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Retrieving Freq Weights&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;=======================&quot;</span><span class="p">)</span>
            <span class="n">full_par</span><span class="p">[</span><span class="s1">&#39;fW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">fW</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">temp_w_par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">())</span>
            <span class="n">log</span><span class="p">(</span><span class="n">temp_w_par</span><span class="o">.</span><span class="n">fW</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>


        <span class="c1"># pass through to backend processing script</span>
        <span class="n">_ds</span><span class="p">,</span> <span class="n">_t</span><span class="p">,</span> <span class="n">_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="n">_flags</span> <span class="o">=</span> <span class="n">master_proc_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> 
                                                            <span class="n">data_list</span><span class="p">,</span> <span class="n">full_par</span><span class="p">)</span>

        <span class="c1"># process flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zap</span> <span class="o">=</span> <span class="n">_flags</span><span class="p">[</span><span class="s1">&#39;zap_flag&#39;</span><span class="p">]</span>

        <span class="c1"># ingore nans? -&gt; make mask for this process</span>
        <span class="n">f_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore_nans</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zap</span><span class="p">:</span>
            <span class="c1"># find first data that isn&#39;t None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_ds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f_mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="c1"># if no freq data, just pass through </span>
                <span class="k">break</span>
         

        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Saving new data products to latest instance&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="n">aval_key_for_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_timesize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># dynspecs</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="n">_ds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;err&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">aval_key_for_time</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">_timesize</span> <span class="o">=</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">f_mask</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># time series</span>
        <span class="n">t_list</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">t_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s2">&quot;err&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">aval_key_for_time</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">_timesize</span> <span class="o">=</span> <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># freq spectra</span>
        <span class="n">f_list</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">f_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># proc freq array, nan </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="n">f_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">aval_key_for_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">get_times</span><span class="p">()</span>

        <span class="k">return</span>


    
    <span class="k">def</span> <span class="nf">_clear_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove specified data products of crops</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list : List(str), optional</span>
<span class="sd">            List of data products to clear, by default None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hkeys</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># remove freqs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clearing data: </span><span class="si">{</span><span class="n">data_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># dynamic spectra</span>
            <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># time series</span>
            <span class="k">elif</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># spectra</span>
            <span class="k">elif</span> <span class="s2">&quot;f&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;freq&quot;</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="c1"># remove freqs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="c1"># remove time samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>



    
    <span class="k">def</span> <span class="nf">_init_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if all requested data products and their</span>
<span class="sd">        dependencies are being requested. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_list: List(str)</span>
<span class="sd">            List of requested cropped data products</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get stokes data to load in</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="n">get_stk_from_datalist</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

        <span class="c1"># check if Q or U is there, and if RM is non-zero, if so</span>
        <span class="c1"># load both Q and U</span>
        <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;Q&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;U&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">RM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># add missing stokes to stk list</span>
            <span class="k">if</span> <span class="s2">&quot;Q&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added Stokes U to process for RM correction&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;U&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added Stokes Q to process for RM correction&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;Q&quot;</span>
        

        <span class="c1"># if norm == &quot;I&quot;, then we want to normalise all data using &quot;I&quot;, this</span>
        <span class="c1"># must add it to the list.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">norm</span> <span class="o">==</span> <span class="s2">&quot;maxI&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added stokes I for normalisation purposes&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;I&quot;</span>


        <span class="k">return</span> <span class="n">stk</span>



            





    

    <span class="c1">##===============================================##</span>
    <span class="c1">##            validate par functions             ##</span>
    <span class="c1">##===============================================##</span>


    <span class="k">def</span> <span class="nf">_update_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return a copy of FRB_params class with updated parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract pars</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_par</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># create copy of par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="o">**</span><span class="n">par</span><span class="p">)</span>

        <span class="c1"># update from crop</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">update_from_crop</span><span class="p">(</span><span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">],</span> <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">],</span>
                                      <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;tN&#39;</span><span class="p">],</span> <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;fN&#39;</span><span class="p">])</span>
        
        
        
        


    <span class="k">def</span> <span class="nf">_update_metapar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return a copy of FRB_metaparams class with updated parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract metapars</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create copy of par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">set_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">metapar</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_update_hyperpar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return updated hyper params</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hyperpar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            
        <span class="c1"># set verbose</span>
        <span class="n">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            



    <span class="k">def</span> <span class="nf">_load_new_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update parameters with keywords for current instance</span>

<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="c1"># make copy of kwargs that change, that way changes that are made do </span>
        <span class="c1"># not propagate </span>
        <span class="n">kwargs_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># check if any are already made static</span>
        <span class="n">static_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs_keys</span><span class="p">:</span>
                    <span class="n">static_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">_G</span><span class="o">.</span><span class="n">sp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">static_keys</span> <span class="k">else</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># add copies of items back in, these will be processed through without touching the</span>
        <span class="c1"># original ones</span>
        <span class="k">for</span> <span class="n">static_key</span> <span class="ow">in</span> <span class="n">static_keys</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">static_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">_G</span><span class="o">.</span><span class="n">sp</span><span class="p">[</span><span class="n">static_key</span><span class="p">]])</span>


        <span class="c1"># copy over current hyperparams to kwargs</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">()</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metapar</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metapar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># make sure metaparameters are updated first  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># update self.this_metapar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># update self.this_par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_par</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># update hyper parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hyperpar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>





    

    <span class="k">def</span> <span class="nf">_save_new_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save Current instance of FRB_params and FRB_metaparams</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># update self.prev_par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update self.prev_metapar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>



    
    <span class="k">def</span> <span class="nf">_from_kwargs_get_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Get all parameters from kwargs dictionary,</span>
<span class="sd">            missing parameters will be taken from [self.par]</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># check if key part of par list</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


        <span class="k">return</span> <span class="n">par</span>



    <span class="k">def</span> <span class="nf">_from_kwargs_get_metapar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Get all Meta parameters from kwargs dictionary,</span>
<span class="sd">            missing meta parameters will be taken from [self.metapar]</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta_par</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># check if key part of meta par list</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">meta_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meta_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_metapar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">meta_par</span>



    <span class="k">def</span> <span class="nf">_proc_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process Kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;physical&quot;</span><span class="p">,</span> <span class="s2">&quot;phase&quot;</span><span class="p">]:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Units for cropping must be one of: [&#39;physical&#39;, &#39;phase&#39;] &quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">check_crop_for_str</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Check for crop &quot;min&quot; and &quot;max&quot; specifiers&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="n">_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span>
            <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
                <span class="n">_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">f_lim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Something went wrong converting crops, no domain chosen.&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>

            <span class="n">phase_vars</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spe</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">spe</span><span class="p">:</span>
                        <span class="c1"># check if other crop comp is phase or ms</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                                <span class="c1"># convert to min/max</span>
                                <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Typing of crop isn&#39;t right. </span><span class="si">{</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Incorrect placement of crop specifiers, must be [&#39;min&#39;, &#39;max&#39;] if being used.&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Typing of crop isn&#39;t right. </span><span class="si">{</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        


        <span class="c1"># check if t_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;t_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_crop_for_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">],</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="o">==</span> <span class="s2">&quot;physical&quot;</span><span class="p">:</span>

                <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_t</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">prev_t</span><span class="p">,</span> <span class="n">snap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting Time crop </span><span class="si">{</span><span class="n">prev_t</span><span class="si">}</span><span class="s2"> ms -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span><span class="p">:</span>
                <span class="c1"># check if within phase units</span>
                <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">):</span>
                    <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">):</span>
                    <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="k">if</span> <span class="n">bad_crop_flag</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase crop in time was out-of-bounds of [0.0, 1.0], setting: [</span><span class="si">{</span><span class="n">prev_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prev_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">] -&gt; [</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>


        <span class="c1"># check if t_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;f_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_crop_for_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">],</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">prev_f</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">new_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">f_lim</span> <span class="o">=</span> <span class="n">prev_f</span><span class="p">,</span> <span class="n">snap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting Freq crop </span><span class="si">{</span><span class="n">prev_f</span><span class="si">}</span><span class="s2"> MHz -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># check if terr_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;terr_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;terr_crop&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;terr_crop&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_crop_for_str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;terr_crop&quot;</span><span class="p">],</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="o">==</span> <span class="s2">&quot;physical&quot;</span><span class="p">:</span>
                    <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_t</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">prev_t</span><span class="p">,</span> <span class="n">snap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting err Time crop </span><span class="si">{</span><span class="n">prev_t</span><span class="si">}</span><span class="s2"> ms -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_units</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span><span class="p">:</span>
                    <span class="c1"># check if within phase units</span>
                    <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">):</span>
                        <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">):</span>
                        <span class="n">bad_crop_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="k">if</span> <span class="n">bad_crop_flag</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase error crop in time was out-of-bounds of [0.0, 1.0], setting: [</span><span class="si">{</span><span class="n">prev_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prev_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">] -&gt; [</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        
            



    



    <span class="c1">## [ CHECK IF DATA PROUCTS ARE VALID ] ##</span>
    <span class="k">def</span> <span class="nf">_isvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_products</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if data products are valid, are they loaded? Do their shapes match</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_products : list(str), optional</span>
<span class="sd">            Data products to check against, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            0 if failed, 1 if passed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_products</span><span class="p">:</span>
            <span class="c1"># check if none</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing data for [</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
            
            <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="c1"># check if shape of all data matches</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_shape</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Data shape mismatch between loaded Dynamic spectra&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">1</span>



    <span class="k">def</span> <span class="nf">_iserr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if off-pulse region crop parameters, i.e. terr_crop</span>
<span class="sd">        has been given, if so the off-pulse rms will be calculated.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    

    <span class="k">def</span> <span class="nf">_isdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isinstance</span>






    <span class="c1">##===============================================##</span>
    <span class="c1">##             Diagnostic functions              ##</span>
    <span class="c1">##===============================================##</span>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Print info about FRB class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#create string outlining parameters</span>

        <span class="n">outstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="s2">&quot; Crop Parameters &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;PARAMETERS:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;SAVED:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;INST:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            
            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val2</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>


        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="s2">&quot; Data Parameters &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;PARAMETERS:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;SAVED:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;INST:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val2</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        
        <span class="c1"># outline loaded data</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;    DATA products   &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;TYPE:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;SHAPE:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1">#now print data instance</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;    DATA instance   &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;TYPE:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;SHAPE/VAL:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">ds_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ds</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Serr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span>
                <span class="n">t_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">Serr</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Serr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span>
                <span class="n">f_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">Serr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">outstr</span> <span class="o">+=</span> <span class="n">ds_str</span> <span class="o">+</span> <span class="n">t_str</span> <span class="o">+</span> <span class="n">f_str</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;freqs:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;top:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, bottom:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        
        <span class="k">def</span> <span class="nf">_print_fitted_params</span><span class="p">(</span><span class="n">pstr</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">pstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;+</span><span class="si">{</span><span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="n">pstr</span>


        <span class="c1"># print fitted params </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">31</span> <span class="o">+</span> <span class="s2">&quot; Fitted Parameters &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">31</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;PARAMETERS:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;VALUES:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;+ ERR:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;- ERR:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="k">if</span> <span class="s2">&quot;RM&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;      Fitted RM      </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">=</span> <span class="n">_print_fitted_params</span><span class="p">(</span><span class="n">outstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s2">&quot;tscatt&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;    Fitted tscatt    </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">=</span> <span class="n">_print_fitted_params</span><span class="p">(</span><span class="n">outstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;tscatt&#39;</span><span class="p">])</span> 

            <span class="k">if</span> <span class="s2">&quot;scintband&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;   Fitted scintband  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outstr</span> <span class="o">=</span> <span class="n">_print_fitted_params</span><span class="p">(</span><span class="n">outstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;scintband&#39;</span><span class="p">])</span> 



        <span class="k">return</span> <span class="n">outstr</span>



    
























    <span class="c1">##===============================================##</span>
    <span class="c1">##            Further FRB processing             ##</span>
    <span class="c1">##===============================================##</span>


    <span class="c1">## [ FIND FRB PEAK AND TAKE REGION AROUND IT ] ##</span>
<div class="viewcode-block" id="FRB.find_frb">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.find_frb">[docs]</a>
    <span class="k">def</span> <span class="nf">find_frb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">_guard</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                <span class="n">_roughrms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function searches the stokes I dynamic spectrum for the most likely</span>
<span class="sd">        location of the frb. It&#39;s important to note that this function will look through</span>
<span class="sd">        the entire dataset regardless of crop parameters. It will first scrunch, so if memory</span>
<span class="sd">        is an issue first set &#39;tN&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigma: int </span>
<span class="sd">            S/N threshold</span>
<span class="sd">        _guard: float </span>
<span class="sd">            gap between estiamted pulse region and </span>
<span class="sd">            off-pulse region for rms and baseband estimation, in (ms)</span>
<span class="sd">        _width: float </span>
<span class="sd">            width of off-pulse region on either side of pulse region in (ms)</span>
<span class="sd">        _roughrms: float </span>
<span class="sd">            rough offset from peak on initial S/N threshold in (ms)</span>
<span class="sd">        **kwargs: </span>
<span class="sd">            FRB parameters + FRB meta-parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        t_crop: list</span>
<span class="sd">            New Phase start and end limits for found frb burst</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for FRB burst, Finding approximate bounds of burst up to a S/N of [</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1">##====================##</span>
        <span class="c1">## check if data valid##</span>
        <span class="c1">##====================## </span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]</span>  
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get dynI spectra (first scrunch)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        


        <span class="c1">##==========================##</span>
        <span class="c1">## First (rough) FRB search ##</span>
        <span class="c1">##==========================##</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Proceeding with First rough FRB search&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>





        <span class="c1"># find max peak</span>
        <span class="n">tpro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tpro</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                                          <span class="c1"># peak sample</span>
        <span class="n">peak</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                                       <span class="c1"># peak phase</span>
        
        <span class="c1"># get t_ref</span>
        <span class="n">t_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">peak</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


        <span class="c1"># take 2 equal length regions away from the peak on either side</span>
        <span class="c1"># and measure rms as a rough first estimate</span>
        <span class="n">pguard</span> <span class="o">=</span> <span class="n">_guard</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase guard</span>
        <span class="n">pwidth</span> <span class="o">=</span> <span class="n">_width</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase width</span>
        <span class="n">proughrms</span> <span class="o">=</span> <span class="n">_roughrms</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="c1"># phase rough rms</span>


        <span class="n">rms_lhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">peak</span> <span class="o">-</span> <span class="n">proughrms</span> <span class="o">-</span> <span class="n">pwidth</span><span class="p">,</span> <span class="n">peak</span> <span class="o">-</span> <span class="n">proughrms</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># lhs region</span>
        <span class="n">rms_rhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">proughrms</span><span class="p">,</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">proughrms</span> <span class="o">+</span> <span class="n">pwidth</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># rhs region</span>

        <span class="n">rms_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rms_lhs</span><span class="p">,</span><span class="n">rms_rhs</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>                                 <span class="c1"># full rms region</span>
        <span class="n">rms_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_dyn</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>                                 <span class="c1"># rms value</span>


        <span class="c1"># apply initial rough S/N estimate</span>
        <span class="n">sig_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">/</span> <span class="n">rms_val</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                                          <span class="c1"># where signal</span>
                                                                                             <span class="c1"># &gt; sigma</span>
        <span class="n">p_start</span> <span class="o">=</span> <span class="n">sig_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pguard</span> <span class="o">-</span> <span class="n">pwidth</span>                          <span class="c1"># new start</span>
        <span class="n">p_end</span>   <span class="o">=</span> <span class="n">sig_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pguard</span> <span class="o">+</span> <span class="n">pwidth</span>                         <span class="c1"># new end</span>


        <span class="c1">##===============================##</span>
        <span class="c1">## second (optomized) FRB search ##</span>
        <span class="c1">##===============================##</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Proceeding with Optomised FRB search&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1"># crop region</span>
        <span class="n">dynI</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span><span class="n">p_start</span><span class="p">,</span><span class="n">p_end</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>                                         <span class="c1"># crop new region</span>


        <span class="c1"># recalculate phase positions of rms</span>
        <span class="n">pwidth</span> <span class="o">=</span> <span class="n">_width</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase width</span>

        <span class="n">rms_lhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">pwidth</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rms_rhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">pwidth</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rms_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rms_lhs</span><span class="p">,</span><span class="n">rms_rhs</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>


        <span class="c1"># S/N calculation, find where signal is greater than S/N = sigma</span>
        <span class="n">rms_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_dyn</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">rms_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="n">tpro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>                                                       <span class="c1"># calculate S/N</span>
        <span class="n">sig_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">/</span> <span class="n">rms_val</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># calculate new t_crop</span>
        <span class="n">t_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_start</span> <span class="o">+</span> <span class="n">sig_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">tpro</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="p">(</span><span class="n">p_end</span> <span class="o">-</span> <span class="n">p_start</span><span class="p">)</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_start</span> <span class="o">+</span> <span class="n">sig_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tpro</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="p">(</span><span class="n">p_end</span> <span class="o">-</span> <span class="n">p_start</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">width</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">width</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">set_metapar</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">t_crop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="n">t_ref</span> <span class="o">=</span> <span class="n">t_ref</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;New t_crop: [</span><span class="si">{:.5f}</span><span class="s2">, </span><span class="si">{:.5f}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New time series 0-point at Maxima of time series: [</span><span class="si">{</span><span class="n">t_ref</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1"># clear dsI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_instance</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dsI&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">t_crop</span><span class="p">,</span> <span class="n">t_ref</span></div>

    










    <span class="c1">##===============================================##</span>
    <span class="c1">##                Plotting Methods               ##</span>
    <span class="c1">##===============================================##</span>
<div class="viewcode-block" id="FRB.plot_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_data">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General Plotting function, choose to plot either dynamic spectrum or time series </span>
<span class="sd">        data for all stokes parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str, optional</span>
<span class="sd">            type of data to plot, by default &quot;dsI&quot;</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            filename to save figure to, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : figure</span>
<span class="sd">            Return Figure Instance</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting [</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">] product.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># plot </span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>







    <span class="c1"># def zap_rfi(self, sigma = 3, **kwargs):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Zap channels based on if RFI is present, this assumes RFI will have an off-pulse RMS &gt; sigma * RMS_median where </span>
    <span class="c1">#     RMS_median is the median RMS of each channel. </span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     sigma : float, optional</span>
    <span class="c1">#         threshold for RFI zapping</span>
        
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     zapchan : np.ndarray</span>
    <span class="c1">#         string of frequency channels to zap</span>
        
    <span class="c1">#     &quot;&quot;&quot;</span>
        
    <span class="c1">#     log(f&quot;zapping RFI&quot;, lpf_col = self.pcol)</span>

    <span class="c1">#     # get data</span>
    <span class="c1">#     data = self.get_data([&quot;dsI&quot;, &quot;fI&quot;], get = True, **kwargs)</span>

    <span class="c1">#     if not self._iserr():</span>
    <span class="c1">#         log(&quot;Off-pulse crop required for RFI zappinh&quot;, lpf_col = self.pcol,</span>
    <span class="c1">#             stype = &quot;err&quot;)</span>
    <span class="c1">#         return None</span>
        
    <span class="c1">#     # flag channels with RMS &gt; then RMS threshold</span>
    <span class="c1">#     print(data[&#39;fIerr&#39;])</span>
    <span class="c1">#     print(np.median(data[&#39;fIerr&#39;]))</span>

    <span class="c1">#     data[&#39;fIerr&#39;] = np.nanstd(data[&#39;dsI&#39;], axis = 1)</span>
    <span class="c1">#     med_rms = np.nanmedian(data[&#39;fIerr&#39;])</span>
    <span class="c1">#     mad_rms = 1.48 * np.nanmedian(np.abs(data[&#39;fIerr&#39;] - med_rms))</span>
    <span class="c1">#     data[&#39;dsI&#39;][data[&#39;fIerr&#39;] &gt; (med_rms + sigma*mad_rms)] = np.nan</span>



    <span class="c1">#     # plot bad channels</span>
    <span class="c1">#     plt.figure(figsize = (10,10))</span>
    <span class="c1">#     plt.imshow(data[&#39;dsI&#39;], aspect = &#39;auto&#39;, extent = [*self.this_par.t_lim, *self.this_par.f_lim])</span>

    <span class="c1">#     plt.show()</span>







<div class="viewcode-block" id="FRB.plot_stokes">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_stokes">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_stokes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> 
            <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Stokes data, by default stokes I, Q, U and V data is plotted</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax: _axes_</span>
<span class="sd">            matplotlib.pyplot.axes object to plot to, default is None</span>
<span class="sd">        Ldebias : bool, optional</span>
<span class="sd">            Plot stokes L debias, by default False</span>
<span class="sd">        sigma : float, optional</span>
<span class="sd">            sigma threshold for error masking, data that is I &lt; sigma * Ierr, mask it out or</span>
<span class="sd">            else weird overflow behavior might be present when calculating stokes ratios, by default 2.0</span>
<span class="sd">        stk_type : str, optional</span>
<span class="sd">            Type of stokes data to plot, &quot;f&quot; for Stokes Frequency data or &quot;t&quot; for time data, by default &quot;f&quot;</span>
<span class="sd">        stk2plot : str, optional</span>
<span class="sd">            string of stokes to plot, for example if &quot;QV&quot;, only stokes Q and V are plotted, by default &quot;IQUV&quot;</span>
<span class="sd">        stk_ratio : bool, optional</span>
<span class="sd">            if true, plot stokes ratios S/I</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            name of file to save figure image, by default None</span>
<span class="sd">        **kwargs : Dict</span>
<span class="sd">            FRB parameter keywords</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : figure</span>
<span class="sd">            Return figure instance</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting stokes [</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">] data&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">I&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">Q&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">U&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">V&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="c1"># check if off-pulse region given</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">err_flag</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Off-pulse crop required for plotting Ldebias&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">,</span>
                <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># data container for plotting</span>
        <span class="n">pstk</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stk_type</span> <span class="ow">in</span> <span class="s2">&quot;ft&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;stk_type can only be t or f&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>

        <span class="c1"># plot</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_stokes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="n">Ldebias</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="n">stk_type</span><span class="p">,</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="n">stk2plot</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="n">stk_ratio</span><span class="p">,</span>
                    <span class="n">plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span> 

        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_stk_</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>






<div class="viewcode-block" id="FRB.plot_crop">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_crop">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stk</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot current crop of of data along with off-pulse crop if given</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stk : str, optional</span>
<span class="sd">            Stokes data to plot, by default &quot;I&quot;</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            name of file to save figure image, by default None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_title</span><span class="p">(</span><span class="s2">&quot;Plotting current crop parameters for visual inspection.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1"># initialise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



        <span class="c1"># get crop in time and frequency, these will be used to draw the bounds of the crops in a larger</span>
        <span class="c1"># dynamic spectrum</span>
        <span class="n">tcrop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">t_crop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fcrop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">f_crop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">terrcrop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># combine crops, these will be crops of the full dynamic spectrum  with bound markers</span>
        <span class="n">fcrop_ds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>       <span class="c1"># by default take full bandwidth</span>
        <span class="n">tpad</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   <span class="c1"># by default we will pad time by 100ms</span>

        <span class="c1"># check of off-pulse region has been given</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">terrcrop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># this essentially ignores the off-pulse region when plotting</span>
            <span class="n">err_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">terrcrop</span> <span class="o">=</span> <span class="n">tcrop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">tcrop_ds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">terrcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">tpad</span>
        <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">terrcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">tpad</span>

        <span class="c1"># cut crop to between [0.0, 1.0]</span>
        <span class="k">if</span> <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">tcrop_ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># get data</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">tcrop_ds</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">fcrop_ds</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;ds</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



        <span class="c1"># plot dynamic spectra</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">],</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> 
                                                             <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Freq [MHz]&quot;</span><span class="p">)</span>

        <span class="n">tcrop</span><span class="p">,</span> <span class="n">fcrop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">phase2lim</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">tcrop</span><span class="p">,</span> <span class="n">f_crop</span> <span class="o">=</span> <span class="n">fcrop</span><span class="p">)</span>
        <span class="n">terrcrop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">phase2lim</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">terrcrop</span><span class="p">)</span>


        <span class="c1"># plot on-pulse time region</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;On-pulse time crop&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>        
        
        <span class="c1"># plot freq region</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="p">[</span><span class="n">fcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;freq crop&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="p">[</span><span class="n">fcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>

        <span class="c1"># plot off-pulse time region</span>
        <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">terrcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Off-pulse time crop&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">terrcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>




        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># title for crop info</span>
        <span class="n">titstr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;t crop: [</span><span class="si">{</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">tcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] [ms]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">titstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;f crop: [</span><span class="si">{</span><span class="n">fcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">fcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] [MHz]&quot;</span>
        <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
            <span class="n">titstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">terr crop: [</span><span class="si">{</span><span class="n">terrcrop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">terrcrop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] [ms]&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">titstr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_crop.png&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>






    <span class="c1">## [ PLOT LORENTZ OF CROP ] ##</span>
<div class="viewcode-block" id="FRB.fit_scintband">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_scintband">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_scintband</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;bayesian&quot;</span><span class="p">,</span><span class="n">priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">statics</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                     <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit for, Find and plot Scintillation bandwidth in FRB</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            method for fitting \n</span>
<span class="sd">            [bayesian] - Use Bilby bayesian Statistics \n</span>
<span class="sd">            [least squares] - Use Scipy.Curve_fit least squares </span>
<span class="sd">        priors : dict, optional</span>
<span class="sd">            Priors for sampling, by default None</span>
<span class="sd">        statics : dict, optional</span>
<span class="sd">            priors to keep constant, by default None</span>
<span class="sd">        fit_params : dict, optional</span>
<span class="sd">            extra arguments for Bilby.run_sampler function, by default None</span>
<span class="sd">        redo : bool, optional</span>
<span class="sd">            if True, will redo fitting in the case that results are cached, this is mainly for BILBY fitting, default is False</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            Save figure to file, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p: pyfit.fit</span>
<span class="sd">            pyfit class structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting for Scintillation bandwidth using [</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">] method.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>
        <span class="c1">##====================##</span>
        <span class="c1">##       get par      ##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># initilise dicts</span>
        <span class="n">priors</span><span class="p">,</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">)</span>

        <span class="c1"># init pars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        


        <span class="c1">##====================##</span>
        <span class="c1">##     do fitting     ##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># get data crop and spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;fI&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        
        <span class="c1"># in the case channel zapping has been performed, first calc residuals of non.nan values</span>
        <span class="c1"># then convert nans to zeros for acf.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zap</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SCintillation fitting with zapped channels not supported yet... I am looking into this with astropy convolution algorithms that properly treat nan values. &quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># caculate acf of residuals</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">yfit</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">yrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>


        <span class="c1"># lags</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">bw</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                         <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>


        <span class="c1"># create instance of fitting</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">lorentz</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">priors</span><span class="p">,</span>
                <span class="n">static</span> <span class="o">=</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_keywords</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span>
                <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">,</span> <span class="n">plotPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotPosterior</span><span class="p">)</span>

        <span class="c1"># fit</span>
        <span class="n">p</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">redo</span> <span class="o">=</span> <span class="n">redo</span><span class="p">)</span>

        <span class="c1"># calculate modulation index</span>
        <span class="c1"># see (Macquart. j. P. et al, 2019) - [The spectral Properties of the bright FRB population]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="c1">#  using error propogation and quick calculus to obtain error</span>
        <span class="n">temp_err</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">m</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> 
        <span class="n">err</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">temp_err</span><span class="o">/</span><span class="n">p</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>

        <span class="n">p</span><span class="o">.</span><span class="n">set_posterior</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

        <span class="c1"># set to fitted params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;scintband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_posteriors</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMS in poly-n = </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> fitting (sum in square of residuals):&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">yrms</span><span class="p">)</span>



        <span class="c1">##===================##</span>
        <span class="c1">##   do plotting     ##</span>
        <span class="c1">##===================##  </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>     
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;STOKES I spectra&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="n">yfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;STOKES I fit&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Freq [MHz]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (arb.)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;polyfit, n = </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_fit_scintband_broad_poly_model.png&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_broad_poly_model.png&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                

            <span class="n">fig</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Freq [MHz]&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Norm acf&quot;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_fit_scintband_residuals.png&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_residuals.png&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


        <span class="c1"># update instance par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span></div>








    <span class="c1">## [ FIT SCATTERING TIMESCALE ] ##</span>
<div class="viewcode-block" id="FRB.fit_tscatt">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_tscatt">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_tscatt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;bayesian&quot;</span><span class="p">,</span> <span class="n">npulse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">statics</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                   <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a series of gaussian&#39;s convolved with a one-sided exponential scattering tai using BILB</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            method for fitting \n</span>
<span class="sd">            [bayesian] - Use Bilby bayesian Statistics \n</span>
<span class="sd">            [least squares] - Use Scipy.Curve_fit least squares </span>
<span class="sd">        npulse : int, optional</span>
<span class="sd">            Number of gaussian to fit, by default 1</span>
<span class="sd">        priors : dict, optional</span>
<span class="sd">            Priors for sampling, by default None</span>
<span class="sd">        statics : dict, optional</span>
<span class="sd">            Priors to keep constant during fitting, by default None</span>
<span class="sd">        fit_params : dict, optional</span>
<span class="sd">            Keyword parameters for Bilby.run_sampler, by default None</span>
<span class="sd">        redo : bool, optional</span>
<span class="sd">            if True, will redo fitting in the case that results are cached, this is mainly for BILBY fitting, default is False</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            filename to save final plot to, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p: pyfit.fit</span>
<span class="sd">            pyfit class structure</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting for Scattering Time and overall burst profile using [</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">] method.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>
        <span class="c1">##====================##</span>
        <span class="c1">## check if data valid##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># initilaise dicts</span>
        <span class="n">priors</span><span class="p">,</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">)</span>

        <span class="c1"># init par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="c1">##====================##</span>
        <span class="c1">##  proc data to fit  ##</span>
        <span class="c1">##====================##</span>
        
        <span class="c1"># get data</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;tI&quot;</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s2">&quot;tI&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># create time profile</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">():</span>
            <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s1">&#39;Ierr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>


        <span class="c1">##==================##</span>
        <span class="c1">##   Do Fitting     ##</span>
        <span class="c1">##==================##</span>

        <span class="c1"># create instance of fitting</span>
        <span class="c1"># the implemented convolution algorithm requires that we snap to integer samples</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">err</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">make_scatt_pulse_profile_func</span><span class="p">(</span><span class="n">npulse</span><span class="p">),</span>
                <span class="n">prior</span> <span class="o">=</span> <span class="n">priors</span><span class="p">,</span> <span class="n">static</span> <span class="o">=</span> <span class="n">statics</span><span class="p">,</span> <span class="n">fit_keywords</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span>
                <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">,</span> <span class="n">plotPosterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotPosterior</span><span class="p">)</span> 
        
        <span class="c1"># fit </span>
        <span class="n">p</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">redo</span> <span class="o">=</span> <span class="n">redo</span><span class="p">)</span>

        <span class="c1"># set to fitted params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;tscatt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_posteriors</span><span class="p">()</span>
        
        <span class="c1"># print best fit parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Time [ms]&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Flux Density (arb.)&quot;</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_fit_tscatt.png&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># save instance parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span></div>


    












<div class="viewcode-block" id="FRB.plot_poincare">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_poincare">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_poincare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">plot_data</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">plot_model</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">normalise</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_1D_stokes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Stokes data on a Poincare Sphere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            filename to save figure to, by default None</span>
<span class="sd">        stk_type : str, optional</span>
<span class="sd">            types of stokes data to plot, by default &quot;f&quot; \n</span>
<span class="sd">            [f] - Plot as a function of frequency \n</span>
<span class="sd">            [t] - Plot as a function of time </span>
<span class="sd">        sigma : float, optional</span>
<span class="sd">            Error threshold used for masking stokes data in the case that stokes/I is being calculated \n</span>
<span class="sd">            this avoids deviding by potentially small numbers and getting weird results,by default 2.0</span>
<span class="sd">        plot_data : bool, optional</span>
<span class="sd">            Plot Data on Poincare sphere, by default True</span>
<span class="sd">        plot_model : bool, optional</span>
<span class="sd">            Plot Polynomial fitted data on Poincare sphere, by default False</span>
<span class="sd">        normalise : bool, optional</span>
<span class="sd">            Plot data on surface of Poincare sphere (this will require normalising stokes data), by default True</span>
<span class="sd">        n : int, optional</span>
<span class="sd">            Maximum order of Polynomial fit, by default 5</span>
<span class="sd">        plot_1D_stokes: bool, optional</span>
<span class="sd">            if True, plot 1D stokes line plots seperately in another figure</span>
<span class="sd">        **kwargs : Dict</span>
<span class="sd">            FRB parameter keywords</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : figure</span>
<span class="sd">            Return figure instance</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting stokes [</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">] data onto poincare sphere.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stk_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;tf&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stokes type must be either time (t) or frequency (f)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">():</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Must specify off-pulse crop region&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># what type of data, time or freq</span>
        <span class="k">if</span> <span class="n">stk_type</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span>
            <span class="n">cbar_lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span>
            <span class="n">cbar_label</span> <span class="o">=</span> <span class="s2">&quot;Time [ms]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>
            <span class="n">cbar_lims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cbar_label</span> <span class="o">=</span> <span class="s2">&quot;Frequency [MHz]&quot;</span>

        <span class="c1"># plot poincare sphere</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">create_poincare_sphere</span><span class="p">(</span><span class="n">cbar_lims</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">,</span> <span class="n">cbar_label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">)</span>

        <span class="n">stk_i</span><span class="p">,</span> <span class="n">stk_m</span> <span class="o">=</span> <span class="n">plot_poincare_track</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span>
                    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">plot_model</span> <span class="o">=</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">normalise</span> <span class="o">=</span> <span class="n">normalise</span><span class="p">,</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_poincare.png&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_poincare.png&quot;</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="c1"># also plot stokes params</span>
        <span class="k">if</span> <span class="n">plot_1D_stokes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stk_type</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span>
            <span class="n">x_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">cbar_lims</span><span class="p">,</span> <span class="n">stk_m</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">fig2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;QUV&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stk_i</span><span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">S</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">stk_m</span><span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="s1">&#39;--r&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;arb. &quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;1D stokes plot&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_poincare_spectra_fit.png&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_poincare_spectra_fit.png&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">fig2</span></div>














<div class="viewcode-block" id="FRB.fit_RM">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_RM">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_RM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit Spectra for Rotation Measure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Method to perform Rotation Measure fitting, by default &quot;RMquad&quot; \n</span>
<span class="sd">            [RMquad] - Fit for the Rotation Measure using the standard quadratic method \n</span>
<span class="sd">            [RMsynth] - Use the RM-tools RM-Synthesis method</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            plot data after fitting if true, by default True</span>
<span class="sd">        fit_params : dict, optional</span>
<span class="sd">            keyword parameters for fitting method, by default None \n</span>
<span class="sd">            [RMquad] - Scipy.optimise.curve_fit keyword params \n</span>
<span class="sd">            [RMsynth] - RMtools_1D.run_synth keyword params</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            filename to save figure to, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p : pyfit.fit</span>
<span class="sd">            pyfit class fitting structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting for RM using [</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">] method.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check which data products are needed</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fQ&quot;</span><span class="p">,</span> <span class="s2">&quot;fU&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMsynth&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fI&quot;</span><span class="p">,</span> <span class="s2">&quot;fQ&quot;</span><span class="p">,</span> <span class="s2">&quot;fU&quot;</span><span class="p">]</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Invalid method for estimating RM&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Must specify &#39;terr_crop&#39; for rms crop if you want to use RMsynth or RMquad&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span>
                <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
        
        <span class="c1">## get data ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">ignore_nans</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">## run fitting for RM ##</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">:</span>
            <span class="c1"># run quadrature method</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;f0 not given, using middle of band&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">cfreq</span>

            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span>
            <span class="c1"># run fitting</span>
            <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">pa0_err</span> <span class="o">=</span> <span class="n">fit_RMquad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMsynth&quot;</span><span class="p">:</span>
            <span class="c1"># run RM synthesis method</span>
            <span class="n">pa0_err</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># do this for now, TODO</span>
            <span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
            <span class="n">Ierr</span><span class="p">,</span> <span class="n">Qerr</span><span class="p">,</span> <span class="n">Uerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Ierr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">]</span> 
            <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">pa0</span> <span class="o">=</span> <span class="n">fit_RMsynth</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">Ierr</span><span class="p">,</span> <span class="n">Qerr</span><span class="p">,</span> <span class="n">Uerr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>


        <span class="c1"># put into pyfit structure</span>
        <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span> <span class="o">=</span> <span class="n">calc_PA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">rmquad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">pa0</span><span class="p">):</span>
            <span class="n">angs</span> <span class="o">=</span> <span class="n">pa0</span> <span class="o">+</span> <span class="n">rm</span><span class="o">*</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">1e12</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">f0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">90</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">angs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">angs</span><span class="p">))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">PA</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">PA_err</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">rmquad</span><span class="p">,</span>
                 <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_posterior</span><span class="p">(</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_posterior</span><span class="p">(</span><span class="s1">&#39;pa0&#39;</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">pa0_err</span><span class="p">,</span> <span class="n">pa0_err</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_posterior</span><span class="p">(</span><span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># set values to fitted_params </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_posteriors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_params</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_posterior</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_is_fit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">()</span>

        <span class="c1"># plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            
            <span class="n">p</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Frequency [MHz]&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;PA [deg]&quot;</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_RM_fit.png&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>


        <span class="k">return</span> <span class="n">p</span></div>









    




<div class="viewcode-block" id="FRB.plot_PA">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_PA">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_PA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ldebias_threshold</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="s2">&quot;ILV&quot;</span><span class="p">,</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_files</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Figure with PA profile, Stokes Time series data, and Stokes I dyspec. If RM is not </span>
<span class="sd">        specified, will be fitted first.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Ldebias_threshold : float, optional</span>
<span class="sd">            Sigma threshold for PA masking, by default 2.0</span>
<span class="sd">        stk2plot : str, optional</span>
<span class="sd">            string of stokes to plot, for example if &quot;QV&quot;, only stokes Q and V are plotted, \n</span>
<span class="sd">            by default &quot;IQUV&quot;, choice between &quot;IQUVLP&quot;</span>
<span class="sd">        flipPA : bool, optional</span>
<span class="sd">            Plot PA between [0, 180] degrees instead of [-90, 90], by default False</span>
<span class="sd">        stk_ratio: bool, optional</span>
<span class="sd">            Plot Stokes ratios in time series ax, by default False</span>
<span class="sd">        fit_params : dict, optional</span>
<span class="sd">            keyword parameters for fitting method, by default None \n</span>
<span class="sd">            [RMquad] - Scipy.optimise.curve_fit keyword params \n</span>
<span class="sd">            [RMsynth] - RMtools_1D.run_synth keyword params</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            filename of figure to save to, by default None</span>
<span class="sd">        save_files : Bool, optional</span>
<span class="sd">            if true, will save 1D .npy file with PA and .npy file with PAerrs, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p : pyfit.fit</span>
<span class="sd">            pyfit class fitting structure</span>
<span class="sd">        fig : figure</span>
<span class="sd">            Return figure instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_title</span><span class="p">(</span><span class="s2">&quot;Plotting PA mosaic image with PA profile, Stokes profile and Dynamic spectra.&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;lblue&quot;</span><span class="p">)</span>

        <span class="c1"># initialise parameters</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Need to specify &#39;terr_crop&#39; for rms estimation&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">RM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;RM not specified, either provide an RM or fit for one using .fit_RM()&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        
        <span class="c1">## get data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="s2">&quot;dsQ&quot;</span><span class="p">,</span> <span class="s2">&quot;dsU&quot;</span><span class="p">,</span> 
                       <span class="s2">&quot;tI&quot;</span><span class="p">,</span>  <span class="s2">&quot;tQ&quot;</span><span class="p">,</span>  <span class="s2">&quot;tU&quot;</span><span class="p">,</span> 
                       <span class="s2">&quot;fQ&quot;</span><span class="p">,</span>  <span class="s2">&quot;fU&quot;</span><span class="p">,</span> <span class="s2">&quot;tV&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdata</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">## calculate PA</span>
        <span class="n">stk_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tQ&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">],</span> <span class="s2">&quot;tU&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span> <span class="s2">&quot;tQerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Qerr&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;tUerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Uerr&quot;</span><span class="p">],</span> <span class="s2">&quot;tIerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Ierr&quot;</span><span class="p">]}</span>
        <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span> <span class="o">=</span> <span class="n">calc_PAdebiased</span><span class="p">(</span><span class="n">stk_data</span><span class="p">,</span> <span class="n">Ldebias_threshold</span> <span class="o">=</span> <span class="n">Ldebias_threshold</span><span class="p">)</span>

        <span class="c1"># create figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">AX</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="s2">&quot;P;S;D&quot;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
                    <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="n">PA</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1">## plot PA</span>
        <span class="n">plot_PA</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="n">flipPA</span><span class="p">)</span>

        <span class="c1">## plot Spectra</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">_x</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="n">pdat</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
            <span class="n">pdat</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

        <span class="n">plot_stokes</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">],</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="n">stk2plot</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                    <span class="n">plot_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="n">stk_ratio</span><span class="p">)</span>

        <span class="c1">## plot dynamic spectra</span>
        <span class="n">ds_freq_lims</span> <span class="o">=</span> <span class="n">fix_ds_freq_lims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                       <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="o">*</span><span class="n">ds_freq_lims</span><span class="p">])</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [MHz]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

        <span class="c1"># adjust figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_PA_mosaic.png&quot;</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving PA data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_PA.npy...&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_PA.npy&quot;</span><span class="p">,</span> <span class="n">PA</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving PA err data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_PAerr.npy...&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_PAerr.npy&quot;</span><span class="p">,</span> <span class="n">PA_err</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>


        <span class="k">return</span> <span class="n">fig</span></div>
</div>

                                                
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tyson Dial.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>