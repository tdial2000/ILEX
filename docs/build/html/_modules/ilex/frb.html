<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ilex.frb &mdash; ILEX 0.9.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=39bb1c6d"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ILEX
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Overview of ILEX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials.html">ILEX Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/ilex.html">ILEX Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ILEX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ilex.frb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ilex.frb</h1><div class="highlight"><pre>
<span></span><span class="c1">##===============================================##</span>
<span class="c1">##===============================================##</span>
<span class="c1">## Author: Tyson Dial</span>
<span class="c1">## Email: tdial@swin.edu.au</span>
<span class="c1">## Last Updated: 25/09/2023 </span>
<span class="c1">##</span>
<span class="c1">##</span>
<span class="c1">## </span>
<span class="c1">## </span>
<span class="c1">## Library of basic functions for analysing FRBs.</span>
<span class="c1">##</span>
<span class="c1">##===============================================##</span>
<span class="c1">##===============================================##</span>
<span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">inspect</span>


<span class="c1">## import utils ##</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">load_data</span><span class="p">,</span> <span class="n">save_data</span><span class="p">,</span> <span class="n">dict_get</span><span class="p">,</span>
                    <span class="n">dict_init</span><span class="p">,</span> <span class="n">dict_isall</span><span class="p">,</span>
                    <span class="n">merge_dicts</span><span class="p">,</span> <span class="n">dict_null</span><span class="p">,</span> <span class="n">get_stk_from_datalist</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">## import FRB stats ##</span>
<span class="kn">from</span> <span class="nn">.fitting</span> <span class="kn">import</span> <span class="n">fit_scint</span><span class="p">,</span> <span class="n">fit_RMquad</span><span class="p">,</span> <span class="n">fit_RMsynth</span><span class="p">,</span> <span class="n">fit_tscatt</span>

<span class="c1">## import FRB params ##</span>
<span class="kn">from</span> <span class="nn">.par</span> <span class="kn">import</span> <span class="n">FRB_params</span><span class="p">,</span> <span class="n">FRB_metaparams</span>

<span class="c1">## import FRB htr functions ##</span>
<span class="kn">from</span> <span class="nn">.htr</span> <span class="kn">import</span> <span class="n">make_stokes</span>

<span class="c1">## import globals ##</span>
<span class="kn">from</span> <span class="nn">.globals</span> <span class="kn">import</span> <span class="n">_G</span><span class="p">,</span> <span class="n">globals_</span> 

<span class="c1">## import plot functions ##</span>
<span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="p">(</span><span class="n">plot_scintband</span><span class="p">,</span> <span class="n">plot_tscatt</span><span class="p">,</span> <span class="n">plot_RM</span><span class="p">,</span> <span class="n">plot_PA</span><span class="p">,</span> <span class="n">plot_stokes</span><span class="p">,</span>      
                  <span class="n">plot_poincare</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">)</span>

<span class="c1">## import processing functions ##</span>
<span class="c1"># from .FRBproc import proc_data</span>

<span class="kn">from</span> <span class="nn">.logging</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">get_verbose</span><span class="p">,</span> <span class="n">set_verbose</span>


<span class="kn">from</span> <span class="nn">.master_proc</span> <span class="kn">import</span> <span class="n">master_proc_data</span>

<span class="kn">from</span> <span class="nn">.multicomp_pol</span> <span class="kn">import</span> <span class="o">*</span>


    

<span class="c1">##===============================================##</span>
<span class="c1">##                  FRB class                    ##</span>
<span class="c1">##===============================================##</span>

<div class="viewcode-block" id="FRB">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB">[docs]</a>
<span class="k">class</span> <span class="nc">FRB</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FRB class for Processing of ASKAP FRB data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str </span>
<span class="sd">        Name of FRB</span>
<span class="sd">    RA: str </span>
<span class="sd">        Right acension position</span>
<span class="sd">    DEC: str </span>
<span class="sd">        Declination position</span>
<span class="sd">    DM: float </span>
<span class="sd">        Dispersion Measure</span>
<span class="sd">    bw: float </span>
<span class="sd">        Bandwidth</span>
<span class="sd">    cfreq: float </span>
<span class="sd">        Central Frequency</span>
<span class="sd">    t_crop: list </span>
<span class="sd">        Crop start and end phase in Time</span>
<span class="sd">    f_crop: list </span>
<span class="sd">        Crop start and end phase in Frequency</span>
<span class="sd">    tN: int </span>
<span class="sd">        Factor for averaging in Time</span>
<span class="sd">    fN: int </span>
<span class="sd">        Factor for averaging in Frequency</span>
<span class="sd">    t_lim: list </span>
<span class="sd">        Limits for FRB in Time</span>
<span class="sd">    f_lim: list </span>
<span class="sd">        Limits for FRB in Frequency</span>
<span class="sd">    RM: float </span>
<span class="sd">        Rotation Measure</span>
<span class="sd">    f0: float </span>
<span class="sd">        Reference Frequency</span>
<span class="sd">    pa0: float </span>
<span class="sd">        Position angle at reference frequency f0</span>
<span class="sd">    verbose: bool </span>
<span class="sd">        Enable verbose logging</span>
<span class="sd">    norm: str</span>
<span class="sd">        Type of normalisation \n</span>
<span class="sd">        [max] - normalise using maximum \n</span>
<span class="sd">        [absmax] - normalise using absolute maximum \n</span>
<span class="sd">        [None] - Skip normalisation</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    par: FRB_params </span>
<span class="sd">        parameters for FRB</span>
<span class="sd">    this_par: FRB_params </span>
<span class="sd">        Current instance of &#39;par&#39;</span>
<span class="sd">    prev_par: FRB_params </span>
<span class="sd">        Last instance of &#39;par&#39;</span>
<span class="sd">    metapar: FRB_metaparams </span>
<span class="sd">        hold meta-parameters for FRB</span>
<span class="sd">    this_metapar: FRB_metaparams </span>
<span class="sd">        Current instance of &#39;metapar&#39;</span>
<span class="sd">    prev_metapar: FRB_metaparams </span>
<span class="sd">        Last instance of &#39;metapar&#39;</span>
<span class="sd">    ds: Dict </span>
<span class="sd">        Dictionary of loaded stokes dynamic spectra</span>
<span class="sd">    pol: Dict </span>
<span class="sd">        Dictionary of loaded Polarisation time series</span>
<span class="sd">    _t: Dict </span>
<span class="sd">        Dictionary of cropped stokes time series</span>
<span class="sd">    _f: Dict </span>
<span class="sd">        Dictionary of cropped stokes spectra</span>
<span class="sd">    _ds: Dict </span>
<span class="sd">        Dictionary of cropped stokes dynamic spectra</span>
<span class="sd">    _freq: np.ndarray </span>
<span class="sd">        Cropped Frequency array</span>
<span class="sd">    verbose: bool </span>
<span class="sd">        Enable logging</span>
<span class="sd">    force: bool </span>
<span class="sd">        En-force use of any loaded cropped data regardless of parameter differences</span>
<span class="sd">    savefig: bool </span>
<span class="sd">        Save all created figures to files</span>
<span class="sd">    pcol: str </span>
<span class="sd">        Color of text for logging</span>
<span class="sd">    empty: bool </span>
<span class="sd">        Variable used to initialise FRB instance and data loading</span>
<span class="sd">    &quot;&quot;&quot;</span>




    <span class="c1">## [ INITIALISE FRB ] ##</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>    <span class="n">RA</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">],</span>    <span class="n">DEC</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span> 
                       <span class="n">DM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;DM&#39;</span><span class="p">],</span>      <span class="n">bw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;bw&#39;</span><span class="p">],</span>    <span class="n">cfreq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cfreq&#39;</span><span class="p">],</span> 
                       <span class="n">t_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>               <span class="n">f_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>           <span class="n">tN</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">fN</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>                 <span class="n">t_lim</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;t_lim&#39;</span><span class="p">],</span>   <span class="n">f_lim</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f_lim&#39;</span><span class="p">],</span>
                       <span class="n">RM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">],</span>      <span class="n">f0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>  <span class="n">pa0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pa0&#39;</span><span class="p">],</span>
                       <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">],</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">],</span> <span class="n">terr_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create FRB instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">FRB_params</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">RA</span> <span class="o">=</span> <span class="n">RA</span><span class="p">,</span> <span class="n">DEC</span> <span class="o">=</span> <span class="n">DEC</span><span class="p">,</span> 
                              <span class="n">DM</span> <span class="o">=</span> <span class="n">DM</span><span class="p">,</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">bw</span><span class="p">,</span> <span class="n">cfreq</span> <span class="o">=</span> <span class="n">cfreq</span><span class="p">,</span>
                              <span class="n">t_lim</span> <span class="o">=</span> <span class="n">t_lim</span><span class="p">,</span> <span class="n">f_lim</span> <span class="o">=</span> <span class="n">f_lim</span><span class="p">,</span> 
                              <span class="n">RM</span> <span class="o">=</span> <span class="n">RM</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">f0</span><span class="p">,</span> <span class="n">pa0</span> <span class="o">=</span> <span class="n">pa0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span> <span class="o">=</span> <span class="n">FRB_params</span><span class="p">(</span><span class="n">EMPTY</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span> <span class="o">=</span> <span class="n">FRB_metaparams</span><span class="p">(</span><span class="n">t_crop</span> <span class="o">=</span> <span class="n">t_crop</span><span class="p">,</span> <span class="n">f_crop</span> <span class="o">=</span> <span class="n">f_crop</span><span class="p">,</span>
                        <span class="n">terr_crop</span> <span class="o">=</span> <span class="n">terr_crop</span><span class="p">,</span> <span class="n">tN</span> <span class="o">=</span> <span class="n">tN</span><span class="p">,</span> <span class="n">fN</span> <span class="o">=</span> <span class="n">fN</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">t_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">t_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>    <span class="c1"># crop of time axis</span>
        <span class="k">if</span> <span class="n">f_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">f_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>    <span class="c1"># crop of frequency axis</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span> <span class="o">=</span> <span class="n">FRB_metaparams</span><span class="p">(</span><span class="n">EMPTY</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


        <span class="c1">## Create data containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container for Dynamic spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol</span> <span class="o">=</span> <span class="p">{}</span>                   <span class="c1"># container for polarisation time series data (X, Y)</span>

        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="s2">&quot;XY&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        
        <span class="c1">## data instance containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container to store time series data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># container to store frequency spectra data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="p">{}</span>                   <span class="c1"># container to store dynamic spectra data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># container to store baseband frequency data</span>

        <span class="c1"># initilise data containers</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="s2">&quot;XY&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>               <span class="c1"># used to initialise FRB instance and data loading </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>          <span class="c1"># TODO: implement</span>
        <span class="c1"># set verbose</span>
        <span class="n">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1"># Force use of Parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savefig</span> <span class="o">=</span> <span class="kc">False</span>            <span class="c1"># save figures instead of plotting them</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span> <span class="o">=</span> <span class="s1">&#39;cyan&#39;</span>              <span class="c1"># color for verbose printing</span>



    <span class="c1">##===============================================##</span>
    <span class="c1">##            retrive data funtions              ##</span>
    <span class="c1">##===============================================##</span>

    
    <span class="c1">## [ LOAD IN DATA ] ##</span>
<div class="viewcode-block" id="FRB.load_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.load_data">[docs]</a>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_I</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ds_Q</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ds_U</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ds_V</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">pol_X</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pol_Y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mmap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Load data</span>

<span class="sd">        Args:</span>
<span class="sd">            ds_I (str): Filename of stokes I dynamic spectra</span>
<span class="sd">            ds_Q (str): Filename of stokes Q dynamic spectra</span>
<span class="sd">            ds_U (str): Filename of stokes U dynamic spectra</span>
<span class="sd">            ds_V (str): Filename of stokes V dynamic spectra</span>
<span class="sd">            pol_X (str): Filename of X polarisation time series</span>
<span class="sd">            pol_Y (str): Filename of Y polarisation time series</span>
<span class="sd">            param_file (str): Filename of param yaml file</span>
<span class="sd">            mmap (bool): Enable memory mapping for loading</span>
<span class="sd">            _init (bool): For initial Data loading</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">init_par_from_load</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialise a number of parameters from loaded file</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                     <span class="c1"># assumed that dyn spec is [freq,time]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">df</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">bw</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nchan</span>           <span class="c1"># delta freq in (MHz)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">dt</span>    <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">df</span>                     <span class="c1"># delta time in (ms) [micro seconds]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">t_lim</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">nsamp</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>



        <span class="c1">## dict. of files that will be loaded in</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ds_I&quot;</span><span class="p">:</span> <span class="n">ds_I</span><span class="p">,</span> <span class="s2">&quot;ds_Q&quot;</span><span class="p">:</span> <span class="n">ds_Q</span><span class="p">,</span> <span class="s2">&quot;ds_U&quot;</span><span class="p">:</span> <span class="n">ds_U</span><span class="p">,</span> <span class="s2">&quot;ds_V&quot;</span><span class="p">:</span> <span class="n">ds_V</span><span class="p">,</span>
                      <span class="s2">&quot;pol_X&quot;</span><span class="p">:</span> <span class="n">pol_X</span><span class="p">,</span> <span class="s2">&quot;pol_Y&quot;</span><span class="p">:</span> <span class="n">pol_Y</span><span class="p">}</span>


        <span class="c1"># loop through files</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># load all dynamic spectra</span>
                <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mmap</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading stokes </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> Dynspec from: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> with shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">lpf_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">_init</span><span class="p">:</span>
                        <span class="n">init_par_from_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

                <span class="c1"># load all polarisation time series data</span>
                <span class="k">elif</span> <span class="s2">&quot;pol&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mmap</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading Pol </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> from: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> with shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                        <span class="n">lpf_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># for now not in use        </span>
        <span class="k">if</span> <span class="n">param_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">load_params</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span></div>

        
        <span class="c1"># self._proc_kwargs(t_crop = self.metapar.t_crop, f_crop = self.metapar.f_crop,</span>
        <span class="c1">#             terr_crop = self.metapar.terr_crop)</span>



        
    <span class="c1">## [ SAVING FUNCTION - SAVE CROP OF DATA ] ##</span>
<div class="viewcode-block" id="FRB.save_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.save_data">[docs]</a>
    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Save cropped data</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): Cropped data to save</span>
<span class="sd">            filename (str): Common prefix for saved filenames</span>
<span class="sd">            param_file (str): Filename for saved param_file</span>
<span class="sd">            **kwargs: Arguments for FRB_params, FRB_metaparams and FRB hyperparams</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO:</span>

        
        <span class="k">return</span></div>



<div class="viewcode-block" id="FRB.get_freqs">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.get_freqs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Get Frequencies</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span></div>





        
    <span class="c1"># implement FRB_params struct  </span>
    <span class="c1">## [ GET DATA ] ##</span>
<div class="viewcode-block" id="FRB.get_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.get_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Create/Get crops of data from loaded data</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): Requested crop products</span>
<span class="sd">            get (bool): Return crop products</span>
<span class="sd">            **kwargs: </span>

<span class="sd">        Returns:</span>
<span class="sd">            data (dict): Dictionary of data products to return, only if get == True</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update par and metapar if nessesary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        

        <span class="c1"># process data_list as str</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_list</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hkeys</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_list</span><span class="p">]</span>
                
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving the following data: </span><span class="si">{</span><span class="n">data_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1">## check if instance of data already exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_instance</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
            <span class="c1">## if check fails, will need to make new data</span>
            <span class="c1"># get the data_products needed to make new instance</span>
            <span class="n">data_products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_proc</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>


            <span class="c1">## first check if there is data to use</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isvalid</span><span class="p">(</span><span class="n">data_products</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loaded data not avaliable or incorrect DS shapes&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span>
                    <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>


            <span class="c1">## make new instances</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_instance</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>


            <span class="c1">## set new instance param </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Loading previous crop&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1"># check if get is true</span>
        <span class="k">if</span> <span class="n">get</span><span class="p">:</span>
            <span class="c1"># return instance</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>


        <span class="c1">#return data</span>
        <span class="k">return</span></div>




    <span class="k">def</span> <span class="nf">_check_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Check for requested data in current instance</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            data_list (list): Requested cropped data products</span>

<span class="sd">        Returns:</span>
<span class="sd">            returns 1 if check passed, else 0 if not.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dict_isall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">(),</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;params do not match&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dict_isall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">(),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;metaparams do not match&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        
        <span class="c1">## check for data in instance</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ds&quot;</span><span class="p">:[],</span> <span class="s2">&quot;t&quot;</span><span class="p">:[],</span> <span class="s2">&quot;f&quot;</span><span class="p">:[]}</span>
        <span class="n">freq_shape</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># dynamic spectra</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ds&quot;</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;ds&quot;</span>
            
            <span class="c1"># time series</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span>
                <span class="n">daterr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>

            <span class="c1"># frequency spectra</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span>
                <span class="n">daterr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span>

            
            <span class="c1"># check data</span>
            <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2"> is missing, will be made&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">_shape</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err_flag</span> <span class="ow">and</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s2">&quot;ds&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">daterr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">err is missing, will be made&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
                    <span class="n">_shape</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daterr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


            <span class="c1"># frequency band array</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;freq&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;freq data is missing, will be made&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="n">freq_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="o">.</span><span class="n">shape</span>


        <span class="c1">## check if all shapes match up</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;cropped ds shapes do not match, will be remade&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;cropped t shapes do not match, will be remade&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;cropped f shapes do not match, will be remade&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1">## check if cross products i.e. ds and t match up</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# samples for ds and t do not match, data will be remade</span><span class="se">\n</span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# channels for ds and f do not match, data will be remade</span><span class="se">\n</span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">freq_shape</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">freq_shape</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# channels for ds and freq do not match, data will be remade</span><span class="se">\n</span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">freq_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">freq_shape</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">freq_shape</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# channels for f and freq do not match, data will be remade</span><span class="se">\n</span><span class="si">{</span><span class="n">_shape</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">freq_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>

        
        <span class="c1">## all checks passed, return true</span>
        <span class="k">return</span> <span class="mi">1</span>



    <span class="k">def</span> <span class="nf">_get_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Retrieve and return instances of data</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): List of requested cropped data products</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialise new data list</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># dynamic spectra</span>
            <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># time series</span>
            <span class="k">elif</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

            <span class="c1"># frequency spectra</span>
            <span class="k">elif</span> <span class="s2">&quot;f&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_data</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

        <span class="c1"># also add freqs</span>
        <span class="n">new_data</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span>
        

        <span class="k">return</span> <span class="n">new_data</span>



    <span class="k">def</span> <span class="nf">_make_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Make New instances of cropped data products</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): List of requested cropped data products</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assuming all prior checks on data were successful</span>

        <span class="c1"># purge everything</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span><span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># loop through data products</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>

        <span class="c1"># set up parameter dictionary</span>
        <span class="n">full_par</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">(),</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">())</span>

        <span class="c1"># pass through to backend processing script</span>
        <span class="n">_ds</span><span class="p">,</span> <span class="n">_t</span><span class="p">,</span> <span class="n">_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="n">master_proc_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> 
                                                            <span class="n">data_list</span><span class="p">,</span> <span class="n">full_par</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Saving new data products to latest instance&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># dynspecs</span>
        <span class="n">ds_list</span> <span class="o">=</span> <span class="n">_ds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># time series</span>
        <span class="n">t_list</span> <span class="o">=</span> <span class="n">_t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">t_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># freq spectra</span>
        <span class="n">f_list</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>


    
    <span class="k">def</span> <span class="nf">_clear_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Clear instances of cropped data products</span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): List of requested cropped data products</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="n">_G</span><span class="o">.</span><span class="n">hkeys</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># remove freqs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clearing data: </span><span class="si">{</span><span class="n">data_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># dynamic spectra</span>
            <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># time series</span>
            <span class="k">elif</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># spectra</span>
            <span class="k">elif</span> <span class="s2">&quot;f&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;freq&quot;</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="c1"># remove freqs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>



    
    <span class="k">def</span> <span class="nf">_init_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Check if all requested data products and their</span>
<span class="sd">            dependencies are being requested. </span>

<span class="sd">        Args:</span>
<span class="sd">            data_list (list): List of requested cropped data products</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get stokes data to load in</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="n">get_stk_from_datalist</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

        <span class="c1"># check if Q or U is there, and if RM is non-zero, if so</span>
        <span class="c1"># load both Q and U</span>
        <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;Q&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;U&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">RM</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># add missing stokes to stk list</span>
            <span class="k">if</span> <span class="s2">&quot;Q&quot;</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added Stokes U to process for RM correction&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;U&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added Stokes Q to process for RM correction&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;Q&quot;</span>
        

        <span class="c1"># if norm == &quot;I&quot;, then we want to normalise all data using &quot;I&quot;, this</span>
        <span class="c1"># must add it to the list.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">norm</span> <span class="o">==</span> <span class="s2">&quot;maxI&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Added stokes I for normalisation purposes&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">stk</span> <span class="o">+=</span> <span class="s2">&quot;I&quot;</span>


        <span class="k">return</span> <span class="n">stk</span>



            





    

    <span class="c1">##===============================================##</span>
    <span class="c1">##            validate par functions             ##</span>
    <span class="c1">##===============================================##</span>


    <span class="k">def</span> <span class="nf">_update_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return a copy of FRB_params class with updated parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract pars</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_par</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># create copy of par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">set_par</span><span class="p">(</span><span class="o">**</span><span class="n">par</span><span class="p">)</span>

        <span class="c1"># update from crop</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">update_from_crop</span><span class="p">(</span><span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">],</span> <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">],</span>
                                      <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;tN&#39;</span><span class="p">],</span> <span class="n">metapar</span><span class="p">[</span><span class="s1">&#39;fN&#39;</span><span class="p">])</span>
        
        
        
        


    <span class="k">def</span> <span class="nf">_update_metapar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return a copy of FRB_metaparams class with updated parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># extract metapars</span>
        <span class="n">metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_kwargs_get_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create copy of par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">set_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">metapar</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_update_hyperpar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Return updated hyper params</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hyperpar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            
        <span class="c1"># set verbose</span>
        <span class="n">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            



    <span class="k">def</span> <span class="nf">_load_new_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Update Current instance of FRB_params and FRB_metaparams</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="c1"># make sure metaparameters are updated first  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># update self.this_metapar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_metapar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># update self.this_par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_par</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># update hyper parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hyperpar</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>





    

    <span class="k">def</span> <span class="nf">_save_new_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            save Current instance of FRB_params and FRB_metaparams</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># update self.prev_par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update self.prev_metapar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>



    
    <span class="k">def</span> <span class="nf">_from_kwargs_get_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Get all parameters from kwargs dictionary,</span>
<span class="sd">            missing parameters will be taken from [self.par]</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># check if key part of par list</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


        <span class="k">return</span> <span class="n">par</span>



    <span class="k">def</span> <span class="nf">_from_kwargs_get_metapar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Get all Meta parameters from kwargs dictionary,</span>
<span class="sd">            missing meta parameters will be taken from [self.metapar]</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta_par</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_metapar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># check if key part of meta par list</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">meta_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meta_par</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_metapar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">meta_par</span>



    <span class="k">def</span> <span class="nf">_proc_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process Kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># check if t_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;t_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_t</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">prev_t</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting Time crop </span><span class="si">{</span><span class="n">prev_t</span><span class="si">}</span><span class="s2"> ms -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># check if t_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;f_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">prev_f</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">new_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">f_lim</span> <span class="o">=</span> <span class="n">prev_f</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting Freq crop </span><span class="si">{</span><span class="n">prev_f</span><span class="si">}</span><span class="s2"> MHz -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># check if terr_crop has been given in units of ms</span>
        <span class="k">if</span> <span class="s2">&quot;terr_crop&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">prev_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_t</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">prev_t</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting err Time crop </span><span class="si">{</span><span class="n">prev_t</span><span class="si">}</span><span class="s2"> ms -&gt; </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;terr_crop&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> phase units&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        





    




    





    <span class="c1">## [ CHECK IF DATA PROUCTS ARE VALID ] ##</span>
    <span class="k">def</span> <span class="nf">_isvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_products</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Check if requested Stokes/Pol data to crop is valid</span>

<span class="sd">        Args:</span>
<span class="sd">            data_products (list): List of requested loaded data to use</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_products</span><span class="p">:</span>
            <span class="c1"># check if none</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            
            <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="c1"># check if shape of all data matches</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_shape</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">1</span>



    <span class="k">def</span> <span class="nf">_iserr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Check if error data has been enabled</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    






    <span class="c1">##===============================================##</span>
    <span class="c1">##             Diagnostic functions              ##</span>
    <span class="c1">##===============================================##</span>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Print info about FRB class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#create string outlining parameters</span>

        <span class="n">outstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==== FRB META Parameters =====</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;PARAM:       PROD:       INST:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_G</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metapar</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_metapar</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            
            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:  </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">val2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>


        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==== FRB DATA Parameters =====</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;PARAM:       PROD:       INST:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_G</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_par</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:  </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">val2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        
        <span class="c1"># outline loaded data</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=========================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==    DATA products    ==</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=========================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;TYPE:    SHAPE</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="s2">&quot;XY&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">P</span><span class="si">}</span><span class="s2">:  </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pol</span><span class="p">[</span><span class="n">P</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:   </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1">#now print data instance</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=========================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==    DATA instance    ==</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;=========================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;TYPE:    SHAPE</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">outstr</span> <span class="o">+=</span> <span class="s2">&quot;==============</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">ds_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;ds</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:   </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:    </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Serr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span>
                <span class="n">t_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;t</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">Serr</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">:    </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">S</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Serr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span>
                <span class="n">f_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">Serr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">outstr</span> <span class="o">+=</span> <span class="n">ds_str</span> <span class="o">+</span> <span class="n">t_str</span> <span class="o">+</span> <span class="n">f_str</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outstr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;freqs: top:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, bottom:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            


        <span class="k">return</span> <span class="n">outstr</span>



    
























    <span class="c1">##===============================================##</span>
    <span class="c1">##            Further FRB processing             ##</span>
    <span class="c1">##===============================================##</span>


    <span class="c1">## [ FIND FRB PEAK AND TAKE REGION AROUND IT ] ##</span>
<div class="viewcode-block" id="FRB.find_frb">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.find_frb">[docs]</a>
    <span class="k">def</span> <span class="nf">find_frb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">_guard</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                <span class="n">_roughrms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            find_frb() -&gt; This function searches the stokes I dynamic spectrum for the most likely</span>
<span class="sd">            location of the frb. It&#39;s important to note that this function will look through</span>
<span class="sd">            the entire dataset regardless of crop parameters. It will first scrunch, so if memory</span>
<span class="sd">            is an issue first set &#39;tN&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            sigma (int): S/N threshold</span>
<span class="sd">            _guard (float): gap between estiamted pulse region and </span>
<span class="sd">                            off-pulse region for rms and baseband estimation, in (ms)</span>
<span class="sd">            _width (float): width of off-pulse region on either side of pulse region in (ms)</span>
<span class="sd">            _roughrms (float): rough offset from peak on initial S/N threshold in (ms)</span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns:</span>
<span class="sd">            t_crop (list): New Phase start and end limits for found frb burst</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Looking for FRB burst&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1">##====================##</span>
        <span class="c1">## check if data valid##</span>
        <span class="c1">##====================## </span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f_crop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  

        <span class="c1"># get dynI spectra (first scrunch)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        


        <span class="c1">##==========================##</span>
        <span class="c1">## First (rough) FRB search ##</span>
        <span class="c1">##==========================##</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Proceeding with First rough FRB search&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>





        <span class="c1"># find max peak</span>
        <span class="n">tpro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tpro</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                                          <span class="c1"># peak sample</span>
        <span class="n">peak</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                                       <span class="c1"># peak phase</span>


        <span class="c1"># take 2 equal length regions away from the peak on either side</span>
        <span class="c1"># and measure rms as a rough first estimate</span>
        <span class="n">pguard</span> <span class="o">=</span> <span class="n">_guard</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase guard</span>
        <span class="n">pwidth</span> <span class="o">=</span> <span class="n">_width</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase width</span>
        <span class="n">proughrms</span> <span class="o">=</span> <span class="n">_roughrms</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="c1"># phase rough rms</span>


        <span class="n">rms_lhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">peak</span> <span class="o">-</span> <span class="n">proughrms</span> <span class="o">-</span> <span class="n">pwidth</span><span class="p">,</span> <span class="n">peak</span> <span class="o">-</span> <span class="n">proughrms</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># lhs region</span>
        <span class="n">rms_rhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">proughrms</span><span class="p">,</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">proughrms</span> <span class="o">+</span> <span class="n">pwidth</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># rhs region</span>

        <span class="n">rms_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rms_lhs</span><span class="p">,</span><span class="n">rms_rhs</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>                                 <span class="c1"># full rms region</span>
        <span class="n">rms_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_dyn</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>                                 <span class="c1"># rms value</span>


        <span class="c1"># apply initial rough S/N estimate</span>
        <span class="n">sig_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">/</span> <span class="n">rms_val</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                                          <span class="c1"># where signal</span>
                                                                                             <span class="c1"># &gt; sigma</span>
        <span class="n">p_start</span> <span class="o">=</span> <span class="n">sig_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pguard</span> <span class="o">-</span> <span class="n">pwidth</span>                          <span class="c1"># new start</span>
        <span class="n">p_end</span>   <span class="o">=</span> <span class="n">sig_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pguard</span> <span class="o">+</span> <span class="n">pwidth</span>                         <span class="c1"># new end</span>


        <span class="c1">##===============================##</span>
        <span class="c1">## second (optomized) FRB search ##</span>
        <span class="c1">##===============================##</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Proceeding with Optomised FRB search&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1"># crop region</span>
        <span class="n">dynI</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span><span class="n">p_start</span><span class="p">,</span><span class="n">p_end</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>                                         <span class="c1"># crop new region</span>


        <span class="c1"># recalculate phase positions of rms</span>
        <span class="n">pwidth</span> <span class="o">=</span> <span class="n">_width</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">nsamp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>                                 <span class="c1"># phase width</span>

        <span class="n">rms_lhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">pwidth</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rms_rhs</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">pwidth</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rms_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rms_lhs</span><span class="p">,</span><span class="n">rms_rhs</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>


        <span class="c1"># S/N calculation, find where signal is greater than S/N = sigma</span>
        <span class="n">rms_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_dyn</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">rms_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="n">tpro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dynI</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>                                                       <span class="c1"># calculate S/N</span>
        <span class="n">sig_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tpro</span> <span class="o">/</span> <span class="n">rms_val</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># calculate new t_crop</span>
        <span class="n">t_crop</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_start</span> <span class="o">+</span> <span class="n">sig_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">tpro</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="p">(</span><span class="n">p_end</span> <span class="o">-</span> <span class="n">p_start</span><span class="p">)</span>
        <span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_start</span> <span class="o">+</span> <span class="n">sig_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tpro</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="p">(</span><span class="n">p_end</span> <span class="o">-</span> <span class="n">p_start</span><span class="p">)</span>


        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;New t_crop: [</span><span class="si">{:.5f}</span><span class="s2">, </span><span class="si">{:.5f}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>


        <span class="c1"># clear dsI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_instance</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dsI&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">t_crop</span></div>

    










    <span class="c1">##===============================================##</span>
    <span class="c1">##                Plotting Methods               ##</span>
    <span class="c1">##===============================================##</span>

<span class="c1"># TODO -&gt; Move to .plot</span>
<div class="viewcode-block" id="FRB.plot_ds_int">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_ds_int">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_ds_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stk</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Plot Dynamic spectra in interactive figure with time and freq</span>
<span class="sd">            profiles.</span>

<span class="sd">        Args:</span>
<span class="sd">            stk (str): Stokes data</span>
<span class="sd">            **kwargs</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;ds&quot;</span> <span class="o">+</span> <span class="n">stk</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2"> in interactive mode&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1">##====================##</span>
        <span class="c1">##     create axes    ##</span>
        <span class="c1">##====================##</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">AX</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dynI</span> <span class="o">=</span> <span class="kc">None</span>
        

        <span class="c1">## interactive functions</span>
        <span class="k">class</span> <span class="nc">zoom_cl</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Class to implement event handles when zooming in on dynamic spectra</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">flag_X</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">flag_Y</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">## update xlims</span>
            <span class="k">def</span> <span class="nf">on_zoom_X</span><span class="p">(</span><span class="n">zooms</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
                <span class="n">zooms</span><span class="o">.</span><span class="n">flag_X</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">zooms</span><span class="o">.</span><span class="n">update_zoom</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="c1">## update ylims</span>
            <span class="k">def</span> <span class="nf">on_zoom_Y</span><span class="p">(</span><span class="n">zooms</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
                <span class="n">zooms</span><span class="o">.</span><span class="n">flag_Y</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">zooms</span><span class="o">.</span><span class="n">update_zoom</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="c1">## update profile plots</span>
            <span class="k">def</span> <span class="nf">update_zoom</span><span class="p">(</span><span class="n">self_zoom</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">self_zoom</span><span class="o">.</span><span class="n">flag_X</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self_zoom</span><span class="o">.</span><span class="n">flag_Y</span><span class="p">:</span> <span class="c1"># only update when both x and y lims have changed</span>
                    <span class="k">return</span>
                
                <span class="n">self_zoom</span><span class="o">.</span><span class="n">flag_X</span><span class="p">,</span> <span class="n">self_zoom</span><span class="o">.</span><span class="n">flag_Y</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>


                <span class="n">new_X</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>        <span class="c1"># get x lims</span>
                <span class="n">new_Y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>        <span class="c1"># get y lims</span>

                <span class="n">t_crop</span><span class="p">,</span> <span class="n">f_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">new_X</span><span class="p">,</span> <span class="n">new_Y</span><span class="p">)</span>


                <span class="n">dat</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">*</span><span class="n">t_crop</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>                               <span class="c1"># get crop of data to create</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">pslice</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="o">*</span><span class="n">f_crop</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>                                <span class="c1"># time and freq profiles</span>
                
                <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>       <span class="c1"># clear time profile axis and plot new crop</span>
                <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">new_X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new_X</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">new_X</span><span class="p">)</span>

                <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">new_Y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">new_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="o">*</span><span class="n">new_Y</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">new_Y</span><span class="p">)</span>



        <span class="n">zoom_cb_struct</span> <span class="o">=</span> <span class="n">zoom_cl</span><span class="p">()</span>


        <span class="c1">#create figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>  
        <span class="n">AX</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="n">AX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.7</span><span class="p">]))</span>                              <span class="c1"># add dynamic spectra axes </span>
        <span class="n">AX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.1</span><span class="p">]))</span>                              <span class="c1"># add time profile axes</span>
        <span class="n">AX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.7</span><span class="p">]))</span>                              <span class="c1"># add freq profile axes</span>

        <span class="c1"># dynamic spectra</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Freq [MHz]&quot;</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>                            <span class="c1"># add y label </span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>                             <span class="c1"># add x label</span>

                
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;xlim_changed&#39;</span><span class="p">,</span><span class="n">zoom_cb_struct</span><span class="o">.</span><span class="n">on_zoom_X</span><span class="p">)</span>        <span class="c1"># x lim event handle</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ylim_changed&#39;</span><span class="p">,</span><span class="n">zoom_cb_struct</span><span class="o">.</span><span class="n">on_zoom_Y</span><span class="p">)</span>        <span class="c1"># y lim event handle</span>
        
        <span class="c1"># time profile plot</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                                    <span class="c1"># turn time series profile axes off</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                                    <span class="c1">#</span>

        <span class="c1"># frequency profile plot</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


            

        
        <span class="c1">#fill figure</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="n">data</span><span class="p">]</span>

        <span class="c1"># dynamic spectra</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">)</span>

        <span class="c1"># time profile plot</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">)</span>

        <span class="c1"># frequency profile plot</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">)</span>


        <span class="c1"># return struct of params</span>
        <span class="n">return_</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">()</span>
        <span class="n">return_</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="n">return_</span><span class="o">.</span><span class="n">AX</span>  <span class="o">=</span> <span class="n">AX</span>
        <span class="n">return_</span><span class="o">.</span><span class="n">zoom_interactive_struct</span> <span class="o">=</span> <span class="n">zoom_cb_struct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">return_</span></div>









<span class="c1"># -&gt; Move to .plots</span>
    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            General Plotting function, choose to plot either dynamic spectrum or time series </span>
<span class="sd">            data for all stokes parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str): Data to plot</span>
<span class="sd">            **kwargs</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># flags</span>
        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>


        <span class="c1">##====================##</span>
        <span class="c1">##     create axes    ##</span>
        <span class="c1">##====================##</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        

        <span class="k">if</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ds&quot;</span><span class="p">:</span>   <span class="c1"># dynamic spectrum</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [MHz]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">stk</span><span class="p">],</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">])</span>
            
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>   <span class="c1"># time series</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;arb.&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
            <span class="c1"># plot</span>
            <span class="n">t_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">])</span>

            <span class="c1"># plot err</span>
            <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                <span class="n">ax_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">t_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_xlim</span><span class="p">,</span> <span class="p">[</span><span class="n">t_err</span><span class="p">,</span> <span class="n">t_err</span><span class="p">],</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax_xlim</span><span class="p">)</span>

                <span class="c1"># legend</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;rms&quot;</span><span class="p">])</span>
                
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>    <span class="c1"># freq spectra</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;arb.&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency [MHz]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
            <span class="c1"># plot</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">stk</span><span class="p">])</span>

            <span class="c1"># plot err</span>
            <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">],</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>

                <span class="c1"># legend</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;rms&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<div class="viewcode-block" id="FRB.plot_data">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_data">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>


        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">stk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">pdat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">)</span>

        <span class="c1"># plot </span>
        <span class="n">plot_data</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span></div>







<div class="viewcode-block" id="FRB.plot_stokes">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_stokes">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_stokes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_L</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debias_threshold</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> 
            <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Plot stokes data</span>

<span class="sd">        Args:</span>
<span class="sd">            L (bool): Plot Stokes L (linear polarisation)</span>
<span class="sd">            stk_type (str): type of stokes data to plot</span>
<span class="sd">                            [t] - time series</span>
<span class="sd">                            [f] - frequency spectra</span>
<span class="sd">            filename (str): filename to save figure to</span>
<span class="sd">            **kwargs: key parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting stokes data&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">I&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">Q&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">U&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}</span><span class="s2">V&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">err_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">()</span>

        <span class="c1"># check if off-pulse region given</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">err_flag</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Off-pulse crop required for plotting Ldebias or stokes ratios&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">,</span>
                <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">)</span>
            <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">stk_ratio</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># data container for plotting</span>
        <span class="n">pstk</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">stk_type</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="n">pstk</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>
            <span class="n">stk_dat</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stk_type</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span>
            <span class="n">pstk</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">lims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">stk_dat</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;stk_type can only be t or f&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">)</span>

        <span class="c1"># put data in container for plotting</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="n">pstk</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stk_dat</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">err_flag</span><span class="p">:</span>
                <span class="n">pstk</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stk_dat</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

        <span class="c1"># plot</span>
        <span class="n">plot_stokes</span><span class="p">(</span><span class="n">pstk</span><span class="p">,</span> <span class="n">plot_L</span> <span class="o">=</span> <span class="n">plot_L</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="n">Ldebias</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="n">stk_type</span><span class="p">,</span>
                    <span class="n">debias_threshold</span> <span class="o">=</span> <span class="n">debias_threshold</span><span class="p">,</span> <span class="n">stk_ratio</span> <span class="o">=</span> <span class="n">stk_ratio</span><span class="p">,</span> <span class="n">stk2plot</span> <span class="o">=</span> <span class="n">stk2plot</span><span class="p">,</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span> 
    

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span></div>










    <span class="c1">## [ PLOT LORENTZ OF CROP ] ##</span>
<div class="viewcode-block" id="FRB.fit_scintband">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_scintband">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_scintband</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Fit for scintillation bandwidth</span>

<span class="sd">        Args:</span>
<span class="sd">            fit_priors (dict): priors for bays fitting</span>
<span class="sd">            static_priors (dict): priors to keep static during fitting</span>
<span class="sd">            fit_params (dict): parameters used to pass into fitting function</span>
<span class="sd">            plot (bool): plot acf and scint function </span>
<span class="sd">            filename (str): filename to save plot</span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns:</span>
<span class="sd">            p (dict): Dictionary of fitting parameters</span>
<span class="sd">            spec_lags (ndarray): spectral lags of acf in MHz</span>
<span class="sd">            spec_acf (ndarray): acf values (normalised)         </span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Fitting for Scintillation bandwidth&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="c1">##====================##</span>
        <span class="c1">##       get par      ##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># initilise dicts</span>
        <span class="n">fit_priors</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_priors</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">,</span> 
                                                          <span class="n">fit_params</span><span class="p">)</span>

        <span class="c1"># init pars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        


        <span class="c1">##====================##</span>
        <span class="c1">##     do fitting     ##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># get data crop and spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;fI&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">fit_scint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">priors</span> <span class="o">=</span> <span class="n">fit_priors</span><span class="p">,</span> 
                      <span class="n">static_priors</span> <span class="o">=</span> <span class="n">static_priors</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


        <span class="c1"># calculate modulation index</span>
        <span class="c1"># see (Macquart. j. P. et al, 2019) - [The spectral Properties of the bright FRB population]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="c1">#  using error propogation and quick calculus to obtain error</span>
        <span class="n">temp_err</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">plus</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">minus</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> 
        <span class="n">err</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">temp_err</span><span class="o">/</span><span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
        
        <span class="n">p</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Modulated Index:&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m:    </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> (+</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">/-</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">lpf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>


        <span class="c1">##===================##</span>
        <span class="c1">##   do plotting     ##</span>
        <span class="c1">##===================##</span>

        
        

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>        
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_scintband</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">spec_lags</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">spec_acf</span><span class="p">,</span> <span class="n">y_err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> 
                                 <span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
                                 <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span>

        <span class="c1"># update instance par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">spec_lags</span><span class="p">,</span> <span class="n">spec_acf</span></div>

    












<div class="viewcode-block" id="FRB.plot_poincare">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_poincare">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_poincare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">plot_data</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">plot_model</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_P</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Plotting stokes data to poincare sphere&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stk_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;tf&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stokes type must be either time (t) or frequency (f)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">():</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Must specify off-pulse crop region&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stk_type</span><span class="si">}{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stk_type</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span>
            <span class="n">cbar_lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span>
            <span class="n">cbar_label</span> <span class="o">=</span> <span class="s2">&quot;Time [ms]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>
            <span class="n">cbar_lims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cbar_label</span> <span class="o">=</span> <span class="s2">&quot;Frequency [MHz]&quot;</span>

        <span class="c1"># plot poincare sphere</span>
        <span class="n">plot_poincare</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">plot_model</span> <span class="o">=</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">plot_P</span> <span class="o">=</span> <span class="n">plot_P</span><span class="p">,</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">cbar_lims</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">,</span> <span class="n">cbar_label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span></div>




<div class="viewcode-block" id="FRB.plot_poincare_multi">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_poincare_multi">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_poincare_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">tcrops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fcrops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                            <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_data</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_model</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_on_surface</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_P</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting multiple Poincare tracks&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="n">tcrops</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tcrops</span><span class="p">)</span>
        <span class="n">fcrops</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fcrops</span><span class="p">)</span>

        <span class="c1"># initialise crops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># run function</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>

        <span class="c1"># check the units of tcrops/fcrops</span>
        <span class="k">if</span> <span class="n">tcrops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tcrops</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">tcrops</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">crop</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fcrops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fcrops</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fcrops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">f_lim</span> <span class="o">=</span> <span class="n">crop</span><span class="p">)</span>

        <span class="c1"># combine dict</span>
        <span class="n">full_par</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">())</span>

        <span class="c1"># run multicomp_poincare function</span>
        <span class="n">multicomp_poincare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="n">stk_type</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> 
                            <span class="n">par</span> <span class="o">=</span> <span class="n">full_par</span><span class="p">,</span> <span class="n">tcrops</span> <span class="o">=</span> <span class="n">tcrops</span><span class="p">,</span> <span class="n">fcrops</span> <span class="o">=</span> <span class="n">fcrops</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
                            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">plot_model</span> <span class="o">=</span> <span class="n">plot_model</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
                            <span class="n">plot_on_surface</span> <span class="o">=</span> <span class="n">plot_on_surface</span><span class="p">,</span> <span class="n">plot_P</span> <span class="o">=</span> <span class="n">plot_P</span><span class="p">)</span>
        
        <span class="k">return</span></div>





 














    <span class="c1">## [ FIT SCATTERING TIMESCALE ] ##</span>
<div class="viewcode-block" id="FRB.fit_tscatt">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_tscatt">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_tscatt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npulse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fit_priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Fit for scattering timescale</span>

<span class="sd">        Args:</span>
<span class="sd">            npulse (int): number of convolved pulses to fit for</span>
<span class="sd">            fit_priors (dict): priors for bays fitting</span>
<span class="sd">            static_priors (dict): priors to keep static during fitting</span>
<span class="sd">            fit_params (dict): parameters used to pass into fitting function</span>
<span class="sd">            plot (bool): plot acf and scint function </span>
<span class="sd">            filename (str): filename to save plot</span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns:</span>
<span class="sd">            p (dict): Dictionary of fitting parameters          </span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Fitting for Scattering Time&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
        <span class="c1">##====================##</span>
        <span class="c1">## check if data valid##</span>
        <span class="c1">##====================##</span>

        <span class="c1"># initilaise dicts</span>
        <span class="n">fit_priors</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_priors</span><span class="p">,</span> <span class="n">static_priors</span><span class="p">,</span>
                                                          <span class="n">fit_params</span><span class="p">)</span>

        <span class="c1"># init par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="c1">##====================##</span>
        <span class="c1">##  proc data to fit  ##</span>
        <span class="c1">##====================##</span>
        
        <span class="c1"># get data</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;tI&quot;</span><span class="p">,</span> <span class="n">get</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s2">&quot;tI&quot;</span><span class="p">]</span>

        <span class="c1"># create time profile</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># if error queiried, put in static</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iserr</span><span class="p">():</span>
            <span class="c1"># needs to be in list form as per bilby sigma code</span>
            <span class="n">static_priors</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s1">&#39;Ierr&#39;</span><span class="p">])</span>


        <span class="c1">##==================##</span>
        <span class="c1">##   Do Fitting     ##</span>
        <span class="c1">##==================##</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">fit_tscatt</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">npulse</span> <span class="o">=</span> <span class="n">npulse</span><span class="p">,</span> <span class="n">priors</span> <span class="o">=</span> <span class="n">fit_priors</span><span class="p">,</span>
                       <span class="n">static_priors</span><span class="o">=</span><span class="n">static_priors</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>   
        
        <span class="c1"># print best fit parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>




        <span class="c1">##=====================##</span>
        <span class="c1">##     Do Plotting     ##</span>
        <span class="c1">##=====================##</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_tscatt</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">npulse</span> <span class="o">=</span> <span class="n">npulse</span><span class="p">,</span> 
                              <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span>

        <span class="c1"># save instance parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span></div>





























<div class="viewcode-block" id="FRB.fit_RM">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.fit_RM">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_RM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Fit for Rotation Measure (RM)</span>

<span class="sd">        Args:</span>
<span class="sd">            method (str): Method for RM fitting</span>
<span class="sd">                          [RMquad] -&gt; Quadratic fitting using scipy.curve_fit()</span>
<span class="sd">                          [RMsynth] -&gt; Fit RM using RM synthesis (RMtools)</span>
<span class="sd">            plot (bool): plot RM fitting</span>
<span class="sd">            fit_params (dict): **kwargs for RM fitting</span>
<span class="sd">            filename (str): filename to save figure </span>
<span class="sd">            **kwargs</span>

<span class="sd">        Returns:</span>
<span class="sd">            rm (float): Fitted Rotation Measure</span>
<span class="sd">            rm_err (float): Fitted Rotation Measure error</span>
<span class="sd">            pa0 (float): Position angle</span>
<span class="sd">            pa0_err (float): Position angle error</span>
<span class="sd">            f0 (float): Reference Frequency</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieving RM&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check which data products are needed</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fQ&quot;</span><span class="p">,</span> <span class="s2">&quot;fU&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMsynth&quot;</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fI&quot;</span><span class="p">,</span> <span class="s2">&quot;fQ&quot;</span><span class="p">,</span> <span class="s2">&quot;fU&quot;</span><span class="p">]</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Invalid method for estimating RM&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Must specify &#39;terr_crop&#39; for rms crop if you want to use RMsynth or RMquad&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span>
                <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
        
        <span class="c1">## get data ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1">## run fitting for RM ##</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">:</span>
            <span class="c1"># run quadrature method</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;f0 not given, using middle of band&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">cfreq</span>

            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f0</span>
            <span class="c1"># run fitting</span>
            <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">pa0_err</span> <span class="o">=</span> <span class="n">fit_RMquad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMsynth&quot;</span><span class="p">:</span>
            <span class="c1"># run RM synthesis method</span>
            <span class="n">pa0_err</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># do this for now, TODO</span>
            <span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
            <span class="n">Ierr</span><span class="p">,</span> <span class="n">Qerr</span><span class="p">,</span> <span class="n">Uerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Ierr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">]</span> 
            <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">pa0</span> <span class="o">=</span> <span class="n">fit_RMsynth</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">Ierr</span><span class="p">,</span> <span class="n">Qerr</span><span class="p">,</span> <span class="n">Uerr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>



        <span class="c1">##=====================##</span>
        <span class="c1">##     Do Plotting     ##</span>
        <span class="c1">##=====================##</span>

        <span class="c1">## plot diagnostics ##</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plot_RM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Qerr&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s1">&#39;Uerr&#39;</span><span class="p">],</span> <span class="n">rm</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>


        <span class="k">return</span> <span class="n">rm</span><span class="p">,</span> <span class="n">rm_err</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">pa0_err</span><span class="p">,</span> <span class="n">f0</span></div>









    




<div class="viewcode-block" id="FRB.plot_PA">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_PA">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_PA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">,</span> <span class="n">Ldebias_threshold</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">plot_L</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info:</span>
<span class="sd">            Plot Position angle, Stokes Spectra and I ds at once as a mosaic</span>
<span class="sd">            if RM is not provided, them RM will be fitted and used.</span>

<span class="sd">        Args:</span>
<span class="sd">            method (str): Method for RM fitting</span>
<span class="sd">                          [RMquad] -&gt; Quadratic fitting using scipy.curve_fit()</span>
<span class="sd">                          [RMsynth] -&gt; Fit RM using RM synthesis (RMtools)</span>
<span class="sd">            Ldebias_threshold (float): Threshold for Debiased Linear fraction</span>
<span class="sd">            plot_L (bool): Plot Linear Fraction (L) instead of stokes Q and U</span>
<span class="sd">            fit_params (dict): **kwargs for RM fitting method</span>
<span class="sd">            filename (str): Filename to save mosaic figure</span>
<span class="sd">            **kwargs</span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Plotting PA&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

        <span class="c1"># initialise parameters</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">terr_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Need to specify &#39;terr_crop&#39; for rms estimation&quot;</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">RM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">RM</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">pa0</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_RM</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> 
                                                        <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        
        <span class="c1">## get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s2">&quot;dsI&quot;</span><span class="p">,</span> <span class="s2">&quot;dsQ&quot;</span><span class="p">,</span> <span class="s2">&quot;dsU&quot;</span><span class="p">,</span> 
                       <span class="s2">&quot;tI&quot;</span><span class="p">,</span>  <span class="s2">&quot;tQ&quot;</span><span class="p">,</span>  <span class="s2">&quot;tU&quot;</span><span class="p">,</span> 
                       <span class="s2">&quot;fQ&quot;</span><span class="p">,</span>  <span class="s2">&quot;fU&quot;</span><span class="p">,</span> <span class="s2">&quot;tV&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        

        <span class="c1">## calculate PA</span>
        <span class="n">stk_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Q&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">],</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span> <span class="s2">&quot;tQerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Qerr&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;tUerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Uerr&quot;</span><span class="p">],</span> <span class="s2">&quot;tIerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s2">&quot;Ierr&quot;</span><span class="p">],</span> <span class="s2">&quot;fQerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s2">&quot;Qerr&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;fUerr&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="s2">&quot;Uerr&quot;</span><span class="p">]}</span>
        <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span> <span class="o">=</span> <span class="n">calc_PAdebiased</span><span class="p">(</span><span class="n">stk_data</span><span class="p">,</span> <span class="n">Ldebias_threshold</span> <span class="o">=</span> <span class="n">Ldebias_threshold</span><span class="p">)</span>

        <span class="c1"># create figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">AX</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="s2">&quot;P;S;D&quot;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
                    <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="n">PA</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1">## plot PA</span>
        <span class="n">plot_PA</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="n">flipPA</span><span class="p">)</span>

        <span class="c1">## plot Spectra</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">_x</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="s2">&quot;IQUV&quot;</span><span class="p">:</span>
            <span class="n">pdat</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
            <span class="n">pdat</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">err&quot;</span><span class="p">]</span>

        <span class="n">plot_stokes</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">],</span> <span class="n">stk_type</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">plot_L</span> <span class="o">=</span> <span class="n">plot_L</span><span class="p">,</span> <span class="n">Ldebias</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                    <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">)</span>

        <span class="c1">## plot dynamic spectra</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                       <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">f_lim</span><span class="p">])</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [MHz]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

        <span class="c1"># plot peak in time</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">t_lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">peak</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="s2">&quot;PDS&quot;</span><span class="p">:</span>
            <span class="n">axylim</span> <span class="o">=</span> <span class="n">AX</span><span class="p">[</span><span class="n">A</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">AX</span><span class="p">[</span><span class="n">A</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">axylim</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
            <span class="n">AX</span><span class="p">[</span><span class="n">A</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axylim</span><span class="p">)</span>

        <span class="c1"># adjust figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">AX</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_save_new_params</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span></div>
























<div class="viewcode-block" id="FRB.plot_PA_multi">
<a class="viewcode-back" href="../../_autosummary/ilex.frb.html#ilex.frb.FRB.plot_PA_multi">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_PA_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RMquad&quot;</span><span class="p">,</span> <span class="n">Ldebias_threshold</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">plot_L</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">tcrops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fcrops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">plot_err_type</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Info:</span>
<span class="sd">                Plot Position angle for multiple components, Stokes Spectra and I ds at once as a mosaic</span>
<span class="sd">                if RM is not provided, them RM will be fitted and used.</span>

<span class="sd">            Args:</span>
<span class="sd">                method (str): Method for RM fitting</span>
<span class="sd">                            [RMquad] -&gt; Quadratic fitting using scipy.curve_fit()</span>
<span class="sd">                            [RMsynth] -&gt; Fit RM using RM synthesis (RMtools)</span>
<span class="sd">                Ldebias_threshold (float): Threshold for Debiased Linear fraction</span>
<span class="sd">                tcrops (list): List of t_crop for each component</span>
<span class="sd">                fcrops (list): List of f_crop for each component</span>
<span class="sd">                plot_L (bool): Plot Linear Fraction (L) instead of stokes Q and U</span>
<span class="sd">                fit_params (dict): **kwargs for RM fitting method</span>
<span class="sd">                filename (str): Filename to save mosaic figure</span>
<span class="sd">                **kwargs</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting multiple PA components&quot;</span><span class="p">,</span> <span class="n">lpf_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcol</span><span class="p">)</span>

            <span class="n">tcrops</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tcrops</span><span class="p">)</span>
            <span class="n">fcrops</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fcrops</span><span class="p">)</span>

            <span class="c1"># initialise crops</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_new_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="c1"># initialise parameters</span>
            <span class="n">fit_params</span> <span class="o">=</span> <span class="n">dict_init</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>

            <span class="c1"># run function</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">get_freqs</span><span class="p">()</span>

            <span class="c1"># check the units of tcrops/fcrops</span>
            <span class="k">if</span> <span class="n">tcrops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tcrops</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">tcrops</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">t_lim</span> <span class="o">=</span> <span class="n">crop</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">fcrops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fcrops</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fcrops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">lim2phase</span><span class="p">(</span><span class="n">f_lim</span> <span class="o">=</span> <span class="n">crop</span><span class="p">)</span>

            <span class="c1"># combine dict</span>
            <span class="n">full_par</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_par</span><span class="o">.</span><span class="n">par2dict</span><span class="p">(),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">this_metapar</span><span class="o">.</span><span class="n">metapar2dict</span><span class="p">())</span>

            <span class="n">RM</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">PA_err</span> <span class="o">=</span> <span class="n">multicomp_PA</span><span class="p">(</span><span class="n">stk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                                <span class="n">Ldebias_threshold</span><span class="o">=</span><span class="n">Ldebias_threshold</span><span class="p">,</span> <span class="n">plot_L</span><span class="o">=</span><span class="n">plot_L</span><span class="p">,</span> <span class="n">flipPA</span> <span class="o">=</span> <span class="n">flipPA</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="n">full_par</span><span class="p">,</span>
                                <span class="n">tcrops</span><span class="o">=</span><span class="n">tcrops</span><span class="p">,</span> <span class="n">fcrops</span><span class="o">=</span><span class="n">fcrops</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_err_type</span> <span class="o">=</span> <span class="n">plot_err_type</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
            
            <span class="k">return</span> </div>
</div>








                                                    














</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tyson Dial.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>